import{a as P}from"./chunk-GIJA7IEW.js";import{a as N}from"./chunk-224KP37M.js";import{n as E}from"./chunk-MQVH6ZV5.js";import{$ as p,C as g,Ca as K,E as W,N as j,Qc as z,T as O,X as C,a as _,b as y,d as b,e as S,f as x,g as w,h,q as D}from"./chunk-V4EMFQCR.js";var M={url:"",deserializer:r=>JSON.parse(r.data),serializer:r=>JSON.stringify(r)},$="WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }",d=class r extends x{constructor(e,o){if(super(),this._socket=null,e instanceof b)this.destination=o,this.source=e;else{let i=this._config=Object.assign({},M);if(this._output=new S,typeof e=="string")i.url=e;else for(let s in e)e.hasOwnProperty(s)&&(i[s]=e[s]);if(!i.WebSocketCtor&&WebSocket)i.WebSocketCtor=WebSocket;else if(!i.WebSocketCtor)throw new Error("no WebSocket constructor can be found");this.destination=new h}}lift(e){let o=new r(this._config,this.destination);return o.operator=e,o.source=this,o}_resetState(){this._socket=null,this.source||(this.destination=new h),this._output=new S}multiplex(e,o,i){let s=this;return new b(n=>{try{s.next(e())}catch(a){n.error(a)}let t=s.subscribe({next:a=>{try{i(a)&&n.next(a)}catch(c){n.error(c)}},error:a=>n.error(a),complete:()=>n.complete()});return()=>{try{s.next(o())}catch(a){n.error(a)}t.unsubscribe()}})}_connectSocket(){let{WebSocketCtor:e,protocol:o,url:i,binaryType:s}=this._config,n=this._output,t=null;try{t=o?new e(i,o):new e(i),this._socket=t,s&&(this._socket.binaryType=s)}catch(c){n.error(c);return}let a=new _(()=>{this._socket=null,t&&t.readyState===1&&t.close()});t.onopen=c=>{let{_socket:u}=this;if(!u){t.close(),this._resetState();return}let{openObserver:k}=this._config;k&&k.next(c);let m=this.destination;this.destination=y.create(l=>{if(t.readyState===1)try{let{serializer:f}=this._config;t.send(f(l))}catch(f){this.destination.error(f)}},l=>{let{closingObserver:f}=this._config;f&&f.next(void 0),l&&l.code?t.close(l.code,l.reason):n.error(new TypeError($)),this._resetState()},()=>{let{closingObserver:l}=this._config;l&&l.next(void 0),t.close(),this._resetState()}),m&&m instanceof h&&a.add(m.subscribe(this.destination))},t.onerror=c=>{this._resetState(),n.error(c)},t.onclose=c=>{t===this._socket&&this._resetState();let{closeObserver:u}=this._config;u&&u.next(c),c.wasClean?n.complete():n.error(c)},t.onmessage=c=>{try{let{deserializer:u}=this._config;n.next(u(c))}catch(u){n.error(u)}}}_subscribe(e){let{source:o}=this;return o?o.subscribe(e):(this._socket||this._connectSocket(),this._output.subscribe(e),e.add(()=>{let{_socket:i}=this;this._output.observers.length===0&&(i&&(i.readyState===1||i.readyState===0)&&i.close(),this._resetState())}),e)}unsubscribe(){let{_socket:e}=this;e&&(e.readyState===1||e.readyState===0)&&e.close(),this._resetState(),super.unsubscribe()}};function v(r){return new d(r)}function T(r){let e=[];if(!("updates"in r)||!r.updates)return e;for(let o of r.updates){let i=o.$source||(o.source?o.source.label:"unknown")||"unknown",s=o.timestamp?new Date(o.timestamp).getTime():Date.now();for(let n of o.values){if(!n.path)continue;let t={path:n.path,value:n.value,timestamp:s,source:i};r.context&&(t.context=r.context),e.push(t)}}return e}var A=class r{constructor(e,o,i,s){this.env=e;this.platformId=o;this.store=i;this.aisStore=s}socket$=null;connectionSubscription=null;selfContext=null;_connected=new w(!1);connected$=this._connected.asObservable();connect(){z(this.platformId)&&(this.socket$||(console.log(`Connecting to Signal K WS at ${this.env.signalKWsUrl}`),this.socket$=v({url:this.env.signalKWsUrl,openObserver:{next:()=>{console.log("Signal K WS Connected"),this._connected.next(!0)}},closeObserver:{next:()=>{console.log("Signal K WS Closed"),this._connected.next(!1),this.socket$=null}}}),this.connectionSubscription=this.socket$.pipe(O(e=>this.captureSelfContext(e)),j({delay:3e3}),D(e=>T(e)),g(e=>e.length>0),W(100),g(e=>e.length>0)).subscribe({next:e=>{let o=e.flat(),i=new Map;for(let s of o)this.isSelfContext(s.context)?i.set(s.path,s):s.context&&s.context.startsWith("vessels.")&&this.processAisUpdate(s);i.size>0&&this.store.update(Array.from(i.values()))},error:e=>console.error("WS Error",e)})))}processAisUpdate(e){if(!e.context||this.isSelfContext(e.context))return;let o=e.context.split(":"),i=o[o.length-1];if(!i)return;let s=i;if(s.startsWith("vessels.")&&(s=s.replace("vessels.","")),s.length<9)return;let n={},t=e.value;switch(e.path){case"navigation.position":t&&typeof t.latitude=="number"&&typeof t.longitude=="number"&&(n.latitude=t.latitude,n.longitude=t.longitude);break;case"navigation.speedOverGround":n.sog=typeof t=="number"?t:void 0;break;case"navigation.courseOverGroundTrue":n.cog=typeof t=="number"?t:void 0;break;case"navigation.headingTrue":n.heading=typeof t=="number"?t:void 0;break;case"name":n.name=String(t);break;case"communication.callsignVhf":n.callsign=String(t);break;case"navigation.destination":n.destination=String(t);break}Object.keys(n).length>0&&this.aisStore.updateTarget(s,n,e.timestamp)}disconnect(){this.connectionSubscription&&(this.connectionSubscription.unsubscribe(),this.connectionSubscription=null),this.socket$&&(this.socket$.complete(),this.socket$=null),this._connected.next(!1)}ngOnDestroy(){this.disconnect()}captureSelfContext(e){if(!e||typeof e!="object")return;let o=e,i=o.self??o.contexts?.self;i&&i!==this.selfContext&&(this.selfContext=i,console.log(`[SignalK] self context: ${i}`))}isSelfContext(e){return!e||e==="self"||e==="vessels.self"?!0:!!this.selfContext&&e===this.selfContext}static \u0275fac=function(o){return new(o||r)(p(P),p(K),p(E),p(N))};static \u0275prov=C({token:r,factory:r.\u0275fac,providedIn:"root"})};export{A as a};
