import{a as T,n as I}from"./chunk-MQVH6ZV5.js";import{$ as A,X as _,gc as x,ra as R}from"./chunk-V4EMFQCR.js";import{a as S,b as D}from"./chunk-EQDQRRRY.js";function N(c,n,e,a,r,t,s,p){let m=r-c,b=t-n,v=111132.92-559.82*Math.cos(2*c*Math.PI/180),h=111412.84*Math.cos(c*Math.PI/180),o={x:b*h,y:m*v},l={x:e*Math.sin(a),y:e*Math.cos(a)},g={x:s*Math.sin(p),y:s*Math.cos(p)},i={x:g.x-l.x,y:g.y-l.y},f=i.x*i.x+i.y*i.y,y=o.x*i.x+o.y*i.y;if(f<1e-4)return{tCpa:0,dCpa:Math.sqrt(o.x*o.x+o.y*o.y)};let d=-y/f,u={x:o.x+i.x*d,y:o.y+i.y*d},M=Math.sqrt(u.x*u.x+u.y*u.y);return{tCpa:d,dCpa:M}}var E=1852,V=1200,P=class c{constructor(n){this.datapointStore=n;setInterval(()=>this.cleanupStaleTargets(),this.CLEANUP_INTERVAL_MS)}_targets=R(new Map);targets=this._targets.asReadonly();targetCount=x(()=>this._targets().size);dangerousTargets=x(()=>{let n=[];for(let e of this._targets().values())e.isDangerous&&n.push(e);return n});TIMEOUT_MS=600*1e3;CLEANUP_INTERVAL_MS=60*1e3;updateTarget(n,e,a=Date.now()){let r=this._targets(),t=r.get(n),s={mmsi:n,lastUpdated:a,latitude:e.latitude??t?.latitude??0,longitude:e.longitude??t?.longitude??0},p=e.name??t?.name;p!==void 0&&(s.name=p);let m=e.callsign??t?.callsign;m!==void 0&&(s.callsign=m);let b=e.sog??t?.sog;b!==void 0&&(s.sog=b);let v=e.cog??t?.cog;v!==void 0&&(s.cog=v);let h=e.heading??t?.heading;h!==void 0&&(s.heading=h);let o=e.state??t?.state;o!==void 0&&(s.state=o);let l=e.class??t?.class;l!==void 0&&(s.class=l);let g=e.destination??t?.destination;g!==void 0&&(s.destination=g);let i=e.vesselType??t?.vesselType;i!==void 0&&(s.vesselType=i);let f=e.length??t?.length;f!==void 0&&(s.length=f);let y=e.beam??t?.beam;y!==void 0&&(s.beam=y);let d=t?.cpa;d!==void 0&&(s.cpa=d);let u=t?.tcpa;u!==void 0&&(s.tcpa=u);let M=t?.isDangerous;M!==void 0&&(s.isDangerous=M),(e.latitude!==void 0&&e.longitude!==void 0||e.sog!==void 0&&e.cog!==void 0)&&(s=this.calculateRisk(s));let C=new Map(r);C.set(n,s),this._targets.set(C)}calculateRisk(n){let e=this.datapointStore.get(T.navigation.position)?.value,a=this.datapointStore.get(T.navigation.speedOverGround)?.value,r=this.datapointStore.get(T.navigation.courseOverGroundTrue)?.value;if(!e||typeof a!="number"||typeof r!="number"||!n.latitude||!n.longitude||typeof n.sog!="number"||typeof n.cog!="number")return n;let t=N(e.latitude,e.longitude,a,r,n.latitude,n.longitude,n.sog,n.cog),s=t.tCpa>0&&t.tCpa<V&&t.dCpa<E;return D(S({},n),{cpa:t.dCpa,tcpa:t.tCpa,isDangerous:s})}cleanupStaleTargets(){let n=Date.now(),e=!1,a=this._targets(),r=new Map(a);for(let[t,s]of a)n-s.lastUpdated>this.TIMEOUT_MS&&(r.delete(t),e=!0);e&&this._targets.set(r)}updateRisks(n){}static \u0275fac=function(e){return new(e||c)(A(I))};static \u0275prov=_({token:c,factory:c.\u0275fac,providedIn:"root"})};export{P as a};
