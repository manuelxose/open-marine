import{a as R}from"./chunk-ZNRZW4BI.js";import{a as F}from"./chunk-GIJA7IEW.js";import{$ as l,$a as m,F as u,T as S,X as y,g as f,l as w,m as a,q as h}from"./chunk-V4EMFQCR.js";import{a as p,b as c}from"./chunk-EQDQRRRY.js";var d=class s{constructor(t,e){this.http=t;this.env=e;let r=this.env.signalKBaseUrl.replace(/\/$/,""),i=r.endsWith("/api")?r.slice(0,-4):r,n=r.endsWith("/api")?r:`${r}/api`,b=[`${i.replace(/\/v1$/,"")}/v2/api`,i,n];this.resourcesBases=Array.from(new Set(b)).filter(Boolean)}resourcesBases;getResources(t){return this.requestWithFallback(e=>this.http.get(this.resourceCollectionUrl(e,t)),e=>(console.error(`Error fetching resources [${t}]:`,e),w({})))}getResource(t,e){return this.requestWithFallback(r=>this.http.get(this.resourceItemUrl(r,t,e)),r=>(console.error(`Error fetching resource [${t}/${e}]:`,r),a(()=>r)))}setResource(t,e,r){return this.requestWithFallback(i=>this.http.put(this.resourceItemUrl(i,t,e),r),i=>(console.error(`Error setting resource [${t}/${e}]:`,i),a(()=>i)))}createResource(t,e){return this.requestWithFallback(r=>this.http.post(this.resourceCollectionUrl(r,t),e),r=>(console.error(`Error creating resource [${t}]:`,r),a(()=>r)))}deleteResource(t,e){return this.requestWithFallback(r=>this.http.delete(this.resourceItemUrl(r,t,e)),r=>(console.error(`Error deleting resource [${t}/${e}]:`,r),a(()=>r)))}resourceCollectionUrl(t,e){return`${t}/resources/${e}`}resourceItemUrl(t,e,r){return`${t}/resources/${e}/${r}`}requestWithFallback(t,e){let r=this.resourcesBases[0],i=this.resourcesBases[1];return r?t(r).pipe(u(n=>i&&this.isNotFound(n)?t(i).pipe(u(e)):e(n))):e(new Error("SignalK resources base URL not configured"))}isNotFound(t){return!!t&&typeof t=="object"&&"status"in t&&t.status===404}static \u0275fac=function(e){return new(e||s)(l(R),l(F))};static \u0275prov=y({token:s,factory:s.\u0275fac,providedIn:"root"})};var T=class s{constructor(t){this.skResources=t;this.loadAll()}_waypoints=new f(new Map);waypoints$=this._waypoints.asObservable().pipe(h(t=>Array.from(t.values()).sort((e,r)=>{let i=e.timestamp?new Date(e.timestamp).getTime():0;return(r.timestamp?new Date(r.timestamp).getTime():0)-i})));_loading=new f(!1);loading$=this._loading.asObservable();loadAll(){this._loading.next(!0),this.skResources.getResources("waypoints").subscribe({next:t=>{let e=new Map;if(t)for(let[r,i]of Object.entries(t)){let n=this.normalizeWaypoint(c(p({},i),{id:r}));e.set(r,n)}this._waypoints.next(e),this._loading.next(!1)},error:t=>{console.error("Failed to load waypoints",t),this._loading.next(!1)}})}createWaypoint(t){let e=this.buildWaypointPayloadVariants(t);return this.attemptCreateWaypoint(e).pipe(h(r=>r.id),S(r=>{let i=c(p({},t),{id:r,timestamp:new Date().toISOString()}),n=this._waypoints.value,o=new Map(n);o.set(r,i),this._waypoints.next(o)}),u(r=>(console.error("Failed to create waypoint",r),a(()=>r))))}updateWaypoint(t,e){let r=this._waypoints.value,i=r.get(t);if(!i)return;let n=c(p(p({},i),e),{timestamp:new Date().toISOString()}),o=new Map(r);o.set(t,n),this._waypoints.next(o);let v=this.buildWaypointPayloadVariants(n);this.attemptSetWaypoint(t,v).subscribe({error:b=>{console.error("Failed to update waypoint",b);let W=new Map(this._waypoints.value);W.set(t,i),this._waypoints.next(W)}})}deleteWaypoint(t){let e=this._waypoints.value;if(!e.has(t))return;let r=new Map(e);r.delete(t),this._waypoints.next(r),this.skResources.deleteResource("waypoints",t).subscribe({error:i=>{console.error("Failed to delete waypoint",i);let n=new Map(this._waypoints.value),o=e.get(t);o&&n.set(t,o),this._waypoints.next(n)}})}getWaypoint(t){return this._waypoints.value.get(t)}buildWaypointPayload(t){let e=t.position?.latitude,r=t.position?.longitude,i=Number.isFinite(e)&&Number.isFinite(r),n={};return t.name!==void 0&&(n.name=t.name),t.description!==void 0&&(n.description=t.description),i&&(n.position={latitude:e,longitude:r},n.feature={type:"Feature",geometry:{type:"Point",coordinates:[r,e]},properties:{name:t.name,description:t.description}}),n}buildWaypointPayloadVariants(t){let e=this.buildWaypointPayload(t),r=[];if(e.feature){let n=p({},e);delete n.position,r.push(n);let o={feature:e.feature};r.push(o)}if(e.position){let n=p({},e);delete n.feature,r.push(n);let o={position:e.position};r.push(o)}r.push(e);let i=new Set;return r.filter(n=>{let o=JSON.stringify(n);return i.has(o)?!1:(i.add(o),!0)})}attemptCreateWaypoint(t,e=0){let r=t[e];return r?this.skResources.createResource("waypoints",r).pipe(u(i=>this.isBadRequest(i)&&e<t.length-1?this.attemptCreateWaypoint(t,e+1):a(()=>i))):a(()=>new Error("No valid waypoint payload"))}attemptSetWaypoint(t,e,r=0){let i=e[r];return i?this.skResources.setResource("waypoints",t,i).pipe(u(n=>this.isBadRequest(n)&&r<e.length-1?this.attemptSetWaypoint(t,e,r+1):a(()=>n))):a(()=>new Error("No valid waypoint payload"))}normalizeWaypoint(t){if(!t.position){let e=this.positionFromFeature(t.feature);if(e)return c(p({},t),{position:e})}return t}positionFromFeature(t){if(!t||typeof t!="object")return null;let e=t.geometry;if(!e||e.type!=="Point"||!Array.isArray(e.coordinates))return null;let r=e.coordinates;if(r.length<2)return null;let i=r[0],n=r[1];return typeof n!="number"||typeof i!="number"||!Number.isFinite(n)||!Number.isFinite(i)?null:{latitude:n,longitude:i}}isBadRequest(t){return!!t&&typeof t=="object"&&"status"in t&&t.status===400}static \u0275fac=function(e){return new(e||s)(l(d))};static \u0275prov=y({token:s,factory:s.\u0275fac,providedIn:"root"})};var O=class s{transform(t,e=4){if(t==null||!Number.isFinite(t))return"--";let r=t>=0?"N":"S";return`${Math.abs(t).toFixed(e)}\xB0 ${r}`}static \u0275fac=function(e){return new(e||s)};static \u0275pipe=m({name:"latFormat",type:s,pure:!0})};var $=class s{transform(t,e=4){if(t==null||!Number.isFinite(t))return"--";let r=t>=0?"E":"W";return`${Math.abs(t).toFixed(e)}\xB0 ${r}`}static \u0275fac=function(e){return new(e||s)};static \u0275pipe=m({name:"lonFormat",type:s,pure:!0})};export{d as a,T as b,O as c,$ as d};
