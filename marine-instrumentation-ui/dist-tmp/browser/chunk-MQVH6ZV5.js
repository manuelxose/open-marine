import{$ as H,J as R,X as y,g as v,q as x}from"./chunk-V4EMFQCR.js";import{f as h}from"./chunk-EQDQRRRY.js";var l={name:"name",navigation:{position:"navigation.position",speedOverGround:"navigation.speedOverGround",speedThroughWater:"navigation.speedThroughWater",courseOverGroundTrue:"navigation.courseOverGroundTrue",headingTrue:"navigation.headingTrue",headingMagnetic:"navigation.headingMagnetic",destination:"navigation.destination",attitude:"navigation.attitude",leeway:"navigation.leeway",currentSet:"navigation.current.setTrue",currentDrift:"navigation.current.drift",trip:{log:"navigation.trip.log",lastReset:"navigation.trip.lastReset"},gnss:{satellites:"navigation.gnss.satellites",horizontalDilution:"navigation.gnss.horizontalDilution",type:"navigation.gnss.type"}},communication:{callsignVhf:"communication.callsignVhf"},propulsion:{main:{revolutions:"propulsion.main.revolutions",temperature:"propulsion.main.temperature",oilPressure:"propulsion.main.oilPressure",fuelRate:"propulsion.main.fuel.rate",runTime:"propulsion.main.runTime",transmission:"propulsion.main.transmission.gear"}},tanks:{fuel:{level:"tanks.fuel.0.currentLevel"}},steering:{rudderAngle:"steering.rudderAngle",autopilot:{state:"steering.autopilot.state",target:{headingTrue:"steering.autopilot.target.headingTrue",headingMagnetic:"steering.autopilot.target.headingMagnetic",windAngleApparent:"steering.autopilot.target.windAngleApparent"}}},environment:{depth:{belowTransducer:"environment.depth.belowTransducer",belowSurface:"environment.depth.belowSurface",belowKeel:"environment.depth.belowKeel"},wind:{angleApparent:"environment.wind.angleApparent",speedApparent:"environment.wind.speedApparent",angleTrueGround:"environment.wind.angleTrueGround",angleTrueWater:"environment.wind.angleTrueWater",speedTrue:"environment.wind.speedTrue",directionTrue:"environment.wind.directionTrue"},water:{temperature:"environment.water.temperature"},outside:{temperature:"environment.outside.temperature",pressure:"environment.outside.pressure",humidity:"environment.outside.humidity"}},electrical:{batteries:{house:{voltage:"electrical.batteries.house.voltage",current:"electrical.batteries.house.current",stateOfCharge:"electrical.batteries.house.capacity.stateOfCharge"},alternator:{current:"electrical.batteries.alternator.current"}},solar:{voltage:"electrical.solar.0.voltage",current:"electrical.solar.0.current"}},performance:{polarSpeed:"performance.polarSpeed",polarSpeedRatio:"performance.polarSpeedRatio",targetTwa:"performance.targetAngle",velocityMadeGood:"performance.velocityMadeGood"}};var p=(function(o){return o.Good="good",o.Warn="warn",o.Bad="bad",o})(p||{}),J=[p.Good,p.Warn,p.Bad],Z={[p.Good]:p.Warn,[p.Warn]:p.Bad,[p.Bad]:p.Bad};var F=1.9438444924406,T=6371e3,d=o=>o*Math.PI/180,_=o=>o*180/Math.PI,K=o=>{let e=o%360;return e<0?e+360:e},j=o=>((o+180)%360+360)%360-180,se=o=>o*F,P=(o,e)=>{let t=d(o.lat),n=d(e.lat),i=d(e.lat-o.lat),r=d(e.lon-o.lon),a=Math.sin(i/2),s=Math.sin(r/2),c=a*a+Math.cos(t)*Math.cos(n)*s*s,u=2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c));return T*u},D=(o,e)=>{let t=d(o.lat),n=d(e.lat),i=d(e.lon-o.lon),r=Math.sin(i)*Math.cos(n),a=Math.cos(t)*Math.sin(n)-Math.sin(t)*Math.cos(n)*Math.cos(i);return K(_(Math.atan2(r,a)))},ue=(o,e)=>{let t=P(o,e);return{bearingDeg:D(o,e),distanceNm:t/1852}},ce=(o,e,t)=>{let n=t/T,i=d(e),r=d(o.lat),a=d(o.lon),s=Math.sin(r),c=Math.cos(r),u=Math.sin(n),m=Math.cos(n),f=Math.asin(s*m+c*u*Math.cos(i)),b=a+Math.atan2(Math.sin(i)*u*c,m-s*Math.sin(f));return{lat:_(f),lon:j(_(b))}},le=(o,e)=>o==null||!Number.isFinite(o)?"--":o.toFixed(e),de=(o,e,t)=>{let i=P(o,t)/T,r=d(D(o,t)),a=d(D(o,e)),u=Math.asin(Math.sin(i)*Math.sin(r-a))*T/1852;return{xteNm:u,absXteNm:Math.abs(u),side:u>=0?"starboard":"port"}},me=(o,e,t)=>{let n=d(e-t);return o*Math.cos(n)};var O="navigation.position.latitude",N="navigation.position.longitude";function k(o,e){let n=Date.now()-e;return o.filter(i=>i.timestamp>=n)}function E(o,e,t,n,i){let r=i??n,a=e+Math.PI,s=o*Math.cos(a),c=o*Math.sin(a),u=s*Math.cos(r)-c*Math.sin(r),m=s*Math.sin(r)+c*Math.cos(r),f=t*Math.cos(n),b=t*Math.sin(n),g=u+f,S=m+b,B=Math.sqrt(g*g+S*S),L=Math.atan2(S,g),I=G(L+Math.PI),W=G(I-r);return{tws:B,twd:I,twa:W}}function G(o){let e=Math.PI*2,t=o%e;return t>Math.PI?t-e:t<=-Math.PI?t+e:t}var w=class o{dbName="omi-history";dbVersion=1;storeName="history";dbPromise=null;memoryStore=new Map;addPoint(e,t,n){return h(this,null,function*(){return this.addPoints(e,[t],n)})}addPoints(e,t,n){return h(this,null,function*(){if(!t.length)return;let i=yield this.openDb();if(!i){this.addPointsMemory(e,t);return}yield this.withStore(i,"readwrite",r=>{for(let a of t){let s={path:e,timestamp:a.timestamp,value:a.value};n!==void 0&&(s.source=n),r.put(s)}})})}getRange(e,t,n){return h(this,null,function*(){let i=yield this.openDb();if(!i)return this.getRangeMemory(e,t,n);let r=[],a=IDBKeyRange.bound([e,t],[e,n]);return yield this.withStore(i,"readonly",s=>{let c=s.openCursor(a);c.onsuccess=()=>{let u=c.result;if(!u)return;let m=u.value;r.push({timestamp:m.timestamp,value:m.value}),u.continue()}}),r})}getLatest(e,t=100){return h(this,null,function*(){let n=yield this.openDb();if(!n)return this.getLatestMemory(e,t);let i=[],r=IDBKeyRange.bound([e,0],[e,Number.MAX_SAFE_INTEGER]);return yield this.withStore(n,"readonly",a=>{let s=a.openCursor(r,"prev");s.onsuccess=()=>{let c=s.result;if(!c||i.length>=t)return;let u=c.value;i.push({timestamp:u.timestamp,value:u.value}),c.continue()}}),i.reverse()})}clearPath(e){return h(this,null,function*(){let t=yield this.openDb();if(!t){this.memoryStore.delete(e);return}yield this.withStore(t,"readwrite",n=>{let r=n.index("byPath").openKeyCursor(IDBKeyRange.only(e));r.onsuccess=()=>{let a=r.result;a&&(n.delete(a.primaryKey),a.continue())}})})}clearBefore(e){return h(this,null,function*(){let t=yield this.openDb();if(!t){for(let[n,i]of this.memoryStore.entries())this.memoryStore.set(n,i.filter(r=>r.timestamp>=e));return}yield this.withStore(t,"readwrite",n=>{let r=n.index("byTimestamp").openKeyCursor(IDBKeyRange.upperBound(e));r.onsuccess=()=>{let a=r.result;a&&(n.delete(a.primaryKey),a.continue())}})})}addPointsMemory(e,t){let i=(this.memoryStore.get(e)??[]).concat(t).sort((r,a)=>r.timestamp-a.timestamp);this.memoryStore.set(e,i)}getRangeMemory(e,t,n){return(this.memoryStore.get(e)??[]).filter(r=>r.timestamp>=t&&r.timestamp<=n)}getLatestMemory(e,t){return(this.memoryStore.get(e)??[]).slice(-t)}openDb(){return h(this,null,function*(){return this.dbPromise?this.dbPromise:"indexedDB"in window?(this.dbPromise=new Promise(e=>{let t=indexedDB.open(this.dbName,this.dbVersion);t.onupgradeneeded=()=>{let n=t.result;if(!n.objectStoreNames.contains(this.storeName)){let i=n.createObjectStore(this.storeName,{keyPath:["path","timestamp"]});i.createIndex("byPath","path",{unique:!1}),i.createIndex("byTimestamp","timestamp",{unique:!1})}},t.onsuccess=()=>e(t.result),t.onerror=()=>{console.error("Failed to open history database",t.error),e(null)},t.onblocked=()=>{console.warn("History database upgrade blocked")}}),this.dbPromise):null})}withStore(e,t,n){return new Promise((i,r)=>{let a=e.transaction(this.storeName,t),s=a.objectStore(this.storeName);n(s),a.oncomplete=()=>i(),a.onerror=()=>r(a.error),a.onabort=()=>r(a.error)})}static \u0275fac=function(t){return new(t||o)};static \u0275prov=y({token:o,factory:o.\u0275fac,providedIn:"root"})};var A=1e3,q=1800*1e3,$=1e3,z=10,X=new Set([l.navigation.speedOverGround,l.navigation.courseOverGroundTrue,l.navigation.headingTrue,l.environment.depth.belowTransducer,l.environment.wind.speedApparent,l.environment.wind.angleApparent,l.environment.wind.speedTrue,l.environment.wind.angleTrueGround,l.environment.wind.angleTrueWater,l.electrical.batteries.house.voltage]),M=class{constructor(e){this.capacity=e}buffer=[];push(e){this.buffer.length>=this.capacity&&this.buffer.shift(),this.buffer.push(e)}toArray(){return[...this.buffer]}},C=class o{constructor(e){this.historyService=e;for(let t of Object.keys(this.HISTORY_CONFIG)){let n=this.HISTORY_CONFIG[t];n!==void 0&&(this._history.set(t,new M(n)),this._historySubjects.set(t,new v([])))}}_state=new v(new Map);_history=new Map;_historySubjects=new Map;_trackPoints=new M(A);_trackPoints$=new v([]);track$=this._trackPoints$.asObservable();trackPoints$=this.track$;lastTrackSample=null;_lastUpdate=new v(null);lastUpdate$=this._lastUpdate.asObservable();_updatesProcessed=new v(0);updatesProcessed$=this._updatesProcessed.asObservable();HISTORY_CONFIG={[l.navigation.speedOverGround]:120,[l.environment.wind.speedApparent]:120,[l.environment.depth.belowTransducer]:120,[l.electrical.batteries.house.voltage]:120};state$=this._state.asObservable();update(e){if(e.length===0)return;let t=this._state.value,n=new Map(t);this._updatesProcessed.next(this._updatesProcessed.value+e.length);let i=this._lastUpdate.value??0;for(let r of e){if(n.set(r.path,r),r.timestamp>i&&(i=r.timestamp),r.path===l.navigation.position&&r.value&&typeof r.value=="object"){let a=r.value;if(typeof a.latitude=="number"&&typeof a.longitude=="number"){let s={lat:a.latitude,lon:a.longitude,ts:r.timestamp};this.shouldAppendTrack(s)&&(this._trackPoints.push(s),this.emitTrackPoints(s.ts)),this.historyService.addPoint(O,{timestamp:r.timestamp,value:a.latitude},r.source),this.historyService.addPoint(N,{timestamp:r.timestamp,value:a.longitude},r.source)}}if(this.HISTORY_CONFIG[r.path]&&typeof r.value=="number"){let a=this._history.get(r.path),s=this._historySubjects.get(r.path);a&&s&&(a.push({timestamp:r.timestamp,value:r.value}),s.next(a.toArray()))}X.has(r.path)&&typeof r.value=="number"&&this.historyService.addPoint(r.path,{timestamp:r.timestamp,value:r.value},r.source)}this.deriveTrueWind(n,i||Date.now()),this._state.next(n),this._lastUpdate.next(i||Date.now())}deriveTrueWind(e,t){let n=l,i=e.get(n.environment.wind.speedTrue);if(i&&i.source!=="derived")return;let r=e.get(n.environment.wind.speedApparent)?.value,a=e.get(n.environment.wind.angleApparent)?.value,s=e.get(n.navigation.speedOverGround)?.value,c=e.get(n.navigation.headingTrue)?.value,u=e.get(n.navigation.courseOverGroundTrue)?.value;if(typeof r!="number"||typeof a!="number"||typeof s!="number")return;let m=typeof c=="number"?c:typeof u=="number"?u:void 0;if(typeof m!="number")return;let b=E(r,a,s,typeof u=="number"?u:m,m),g="derived";e.set(n.environment.wind.speedTrue,{path:n.environment.wind.speedTrue,value:b.tws,timestamp:t,source:g}),e.set(n.environment.wind.angleTrueGround,{path:n.environment.wind.angleTrueGround,value:b.twd,timestamp:t,source:g}),e.set(n.environment.wind.angleTrueWater,{path:n.environment.wind.angleTrueWater,value:b.twa,timestamp:t,source:g})}observe(e){return this.state$.pipe(x(t=>t.get(e)),R())}observeHistory(e){return this._historySubjects.has(e)?this._historySubjects.get(e).asObservable():new v([]).asObservable()}series$(e,t){return this.observeHistory(e).pipe(x(n=>k(n,t*1e3)))}get updatesProcessedSnapshot(){return this._updatesProcessed.value}get(e){return this._state.value.get(e)}getAll(){return Array.from(this._state.value.values())}shouldAppendTrack(e){if(!this.lastTrackSample)return this.lastTrackSample=e,!0;let t=e.ts-this.lastTrackSample.ts,n=P({lat:this.lastTrackSample.lat,lon:this.lastTrackSample.lon},{lat:e.lat,lon:e.lon});return t<$&&n<z?!1:(this.lastTrackSample=e,!0)}emitTrackPoints(e){let t=e-q,n=this._trackPoints.toArray().filter(i=>i.ts>=t);n.length>A&&n.splice(0,n.length-A),this._trackPoints$.next(n)}static \u0275fac=function(t){return new(t||o)(H(w))};static \u0275prov=y({token:o,factory:o.\u0275fac,providedIn:"root"})};export{l as a,_ as b,K as c,se as d,P as e,ue as f,ce as g,le as h,de as i,me as j,O as k,N as l,w as m,C as n};
