import{a as oe,b as Ae,c as Ge,d as ze}from"./chunk-GZAK5XFJ.js";import{a as G}from"./chunk-ZM7VQPQC.js";import"./chunk-ZNRZW4BI.js";import"./chunk-GIJA7IEW.js";import{b as Ce,c as A,d as Pe,e as Se,f as Te,h as j,j as Ie,k as Re,m as Me,n as Ee,o as Oe,p as Ve,q as Fe,w as Ne}from"./chunk-GIRLNUDQ.js";import{a as We,f as De,n as Le}from"./chunk-MQVH6ZV5.js";import{a as H}from"./chunk-OR3LRC23.js";import{$ as ee,Bb as d,Bc as re,C as xe,Cc as D,Hc as ke,Ib as X,Jb as he,Ka as c,Kb as T,Mc as L,Nb as l,Ob as P,Pb as q,Qb as we,Ta as be,X as K,Ya as F,aa as ne,bb as f,bc as N,cc as W,ec as ie,fa as u,g as V,ga as g,na as R,nb as m,ob as a,pb as o,q as te,qb as x,ub as M,va as ye,vb as E,xb as y,zb as _}from"./chunk-V4EMFQCR.js";import{a as S,b as I,c as ve}from"./chunk-EQDQRRRY.js";function Be(r,t){r&1&&(a(0,"div",4),x(1,"app-icon",5),a(2,"p"),l(3,"No waypoints created"),o()())}function $e(r,t){if(r&1&&(a(0,"div",17),l(1),N(2,"latFormat"),N(3,"lonFormat"),o()),r&2){let e=t.ngIf;c(),we(" ",W(2,2,e.latitude)," / ",W(3,4,e.longitude)," ")}}function Ke(r,t){r&1&&(a(0,"div",17),l(1,"\u2014"),o())}function Xe(r,t){if(r&1){let e=y();a(0,"div",6),_("click",function(){let i=u(e).$implicit,s=d();return g(s.select.emit(i.id))}),a(1,"div",7),x(2,"app-icon",8),o(),a(3,"div",9)(4,"div",10),l(5),o(),f(6,$e,4,6,"div",11)(7,Ke,2,0,"ng-template",null,0,ie),o(),a(9,"div",12)(10,"app-button",13),_("click",function(i){let s=u(e).$implicit,p=d();return i.stopPropagation(),g(p.edit.emit(s.id))}),x(11,"app-icon",14),o(),a(12,"app-button",15),_("click",function(i){let s=u(e).$implicit,p=d();return i.stopPropagation(),g(p.delete.emit(s.id))}),x(13,"app-icon",16),o()()()}if(r&2){let e=t.$implicit,n=X(8),i=d();T("selected",i.selectedId===e.id),c(2),m("name","crosshair"),c(3),P(e.name||"Unnamed Waypoint"),c(),m("ngIf",e.position)("ngIfElse",n)}}var ae=class r{waypoints=[];selectedId=null;select=new R;edit=new R;delete=new R;trackById(t,e){return e.id}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=F({type:r,selectors:[["app-waypoint-list"]],inputs:{waypoints:"waypoints",selectedId:"selectedId"},outputs:{select:"select",edit:"edit",delete:"delete"},decls:3,vars:3,consts:[["missingCoords",""],[1,"waypoint-list"],["class","empty-state",4,"ngIf"],["class","waypoint-item",3,"selected","click",4,"ngFor","ngForOf","ngForTrackBy"],[1,"empty-state"],["name","locate",1,"empty-icon"],[1,"waypoint-item",3,"click"],[1,"wp-icon"],["size","20",3,"name"],[1,"wp-details"],[1,"wp-name"],["class","wp-coords",4,"ngIf","ngIfElse"],[1,"wp-actions"],["variant","ghost","size","sm","title","Edit",3,"click"],["name","edit","size","18"],["variant","ghost","size","sm","title","Delete",1,"danger-hover",3,"click"],["name","trash","size","18"],[1,"wp-coords"]],template:function(e,n){e&1&&(a(0,"div",1),f(1,Be,4,0,"div",2)(2,Xe,14,6,"div",3),o()),e&2&&(c(),m("ngIf",n.waypoints.length===0),c(),m("ngForOf",n.waypoints)("ngForTrackBy",n.trackById))},dependencies:[L,re,D,H,G,Ge,ze],styles:[".waypoint-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.empty-state[_ngcontent-%COMP%]{padding:3rem;text-align:center;color:var(--gb-text-muted);display:flex;flex-direction:column;align-items:center;gap:1rem}.empty-icon[_ngcontent-%COMP%]{opacity:.5}.waypoint-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:1rem;padding:.75rem;background:var(--gb-bg-panel);border-radius:8px;border:1px solid transparent;cursor:pointer;transition:all .2s ease}.waypoint-item[_ngcontent-%COMP%]:hover{background:var(--surface-3)}.waypoint-item.selected[_ngcontent-%COMP%]{border-color:var(--gb-needle-secondary);background:var(--surface-3)}.wp-icon[_ngcontent-%COMP%]{color:var(--gb-text-muted);display:flex;align-items:center}.wp-details[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;gap:.25rem}.wp-name[_ngcontent-%COMP%]{font-weight:600;color:var(--gb-text-value)}.wp-coords[_ngcontent-%COMP%]{font-size:.75rem;font-family:var(--font-mono);color:var(--gb-text-muted)}.wp-actions[_ngcontent-%COMP%]{display:flex;gap:.25rem;opacity:.6;transition:opacity .2s}.waypoint-item[_ngcontent-%COMP%]:hover   .wp-actions[_ngcontent-%COMP%]{opacity:1}.danger-hover[_ngcontent-%COMP%]:hover{color:var(--danger)}"],changeDetection:0})};function qe(r,t){r&1&&(a(0,"div",21),l(1," Name is required "),o())}function He(r,t){r&1&&(a(0,"span"),l(1,"Saving..."),o())}function Ue(r,t){if(r&1&&(a(0,"span"),l(1),o()),r&2){let e=d();c(),P(e.editMode?"Update":"Create")}}var se=class r{initialValue;editMode=!1;saving=!1;save=new R;cancel=new R;form=new Te({name:new j("",{nonNullable:!0,validators:[A.required]}),lat:new j(0,{nonNullable:!0,validators:[A.required,A.min(-90),A.max(90)]}),lon:new j(0,{nonNullable:!0,validators:[A.required,A.min(-180),A.max(180)]}),description:new j("",{nonNullable:!0}),icon:new j("crosshair",{nonNullable:!0}),color:new j("#ff0000",{nonNullable:!0})});ngOnChanges(t){t.initialValue&&this.initialValue&&this.form.patchValue(this.initialValue)}onSubmit(){this.form.valid?this.save.emit(this.form.getRawValue()):this.form.markAllAsTouched()}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=F({type:r,selectors:[["app-waypoint-form"]],inputs:{initialValue:"initialValue",editMode:"editMode",saving:"saving"},outputs:{save:"save",cancel:"cancel"},features:[ye],decls:36,vars:5,consts:[[1,"wp-form",3,"ngSubmit","formGroup"],[1,"form-field"],["for","wp-name"],["id","wp-name","type","text","formControlName","name","placeholder","Waypoint name",1,"input-control"],["class","error",4,"ngIf"],[1,"form-row"],["for","wp-lat"],["id","wp-lat","type","number","step","0.000001","formControlName","lat",1,"input-control"],["for","wp-lon"],["id","wp-lon","type","number","step","0.000001","formControlName","lon",1,"input-control"],["for","wp-desc"],["id","wp-desc","formControlName","description","rows","3",1,"input-control"],["for","wp-icon"],["id","wp-icon","formControlName","icon",1,"input-control"],["value","crosshair"],["value","target"],["value","anchor"],[1,"form-actions"],["variant","ghost","type","button",3,"click"],["variant","primary","type","submit",3,"disabled"],[4,"ngIf"],[1,"error"]],template:function(e,n){if(e&1&&(a(0,"form",0),_("ngSubmit",function(){return n.onSubmit()}),a(1,"div",1)(2,"label",2),l(3,"Name"),o(),x(4,"input",3),f(5,qe,2,0,"div",4),o(),a(6,"div",5)(7,"div",1)(8,"label",6),l(9,"Latitude"),o(),x(10,"input",7),o(),a(11,"div",1)(12,"label",8),l(13,"Longitude"),o(),x(14,"input",9),o()(),a(15,"div",1)(16,"label",10),l(17,"Description"),o(),x(18,"textarea",11),o(),a(19,"div",5)(20,"div",1)(21,"label",12),l(22,"Icon"),o(),a(23,"select",13)(24,"option",14),l(25,"Crosshair"),o(),a(26,"option",15),l(27,"Target"),o(),a(28,"option",16),l(29,"Anchor"),o()()()(),a(30,"div",17)(31,"app-button",18),_("click",function(){return n.cancel.emit()}),l(32," Cancel "),o(),a(33,"app-button",19),f(34,He,2,0,"span",20)(35,Ue,2,1,"span",20),o()()()),e&2){let i;m("formGroup",n.form),c(5),m("ngIf",((i=n.form.get("name"))==null?null:i.touched)&&((i=n.form.get("name"))==null?null:i.invalid)),c(28),m("disabled",n.form.invalid||n.saving),c(),m("ngIf",n.saving),c(),m("ngIf",!n.saving)}},dependencies:[L,D,Ne,Ie,Ve,Fe,Ce,Re,Oe,Pe,Se,Ee,Me,G],styles:[".wp-form[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1rem}.form-field[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.form-row[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:1rem}label[_ngcontent-%COMP%]{font-size:.875rem;color:var(--gb-text-muted);font-weight:500}.input-control[_ngcontent-%COMP%]{padding:.75rem;border:1px solid var(--border);background:var(--gb-bg-panel);color:var(--gb-text-value);border-radius:4px;font-family:inherit}.input-control[_ngcontent-%COMP%]:focus{outline:none;border-color:var(--gb-needle-secondary)}textarea.input-control[_ngcontent-%COMP%]{resize:vertical}.form-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:1rem;margin-top:1rem}.error[_ngcontent-%COMP%]{color:var(--warn);font-size:.75rem}"],changeDetection:0})};var ce=class{static parse(t){let n=new DOMParser().parseFromString(t,"application/xml");if(n.querySelector("parsererror"))throw new Error("Invalid GPX XML format");let s=[],p=[],b=[],w=n.getElementsByTagName("wpt");for(let v=0;v<w.length;v++){let h=w[v];if(!h)continue;let O=this.parsePoint(h);O&&s.push(O)}let k=n.getElementsByTagName("rte");for(let v=0;v<k.length;v++){let h=k[v];if(!h)continue;let O=this.getChildText(h,"name"),Y=this.getChildText(h,"desc"),J=[],Q=h.getElementsByTagName("rtept");for(let B=0;B<Q.length;B++){let Z=Q[B];if(!Z)continue;let $=this.parsePoint(Z);$&&J.push($)}let z={points:J};O!==void 0&&(z.name=O),Y!==void 0&&(z.desc=Y),p.push(z)}let C=n.getElementsByTagName("trk");for(let v=0;v<C.length;v++){let h=C[v];if(!h)continue;let O=this.getChildText(h,"name"),Y=[],J=h.getElementsByTagName("trkseg");for(let z=0;z<J.length;z++){let B=J[z];if(!B)continue;let Z=B.getElementsByTagName("trkpt");for(let $=0;$<Z.length;$++){let _e=Z[$];if(!_e)continue;let fe=this.parsePoint(_e);fe&&Y.push(fe)}}let Q={points:Y};O!==void 0&&(Q.name=O),b.push(Q)}return{waypoints:s,routes:p,tracks:b}}static parsePoint(t){let e=t.getAttribute("lat"),n=t.getAttribute("lon"),i=e!==null?parseFloat(e):NaN,s=n!==null?parseFloat(n):NaN;if(!Number.isFinite(i)||!Number.isFinite(s))return null;let p=this.getChildText(t,"ele"),b=this.getChildText(t,"time"),w=this.getChildText(t,"name"),k=this.getChildText(t,"desc"),C={lat:i,lon:s};if(p){let v=parseFloat(p);Number.isFinite(v)&&(C.ele=v)}return b!==void 0&&(C.time=b),w!==void 0&&(C.name=w),k!==void 0&&(C.desc=k),C}static getChildText(t,e){let n=t.getElementsByTagName(e)[0];if(!n||n.textContent===null)return;let i=n.textContent.trim();return i.length>0?i:void 0}};function Ye(r,t){if(r&1&&(a(0,"div",10),x(1,"app-icon",11),a(2,"span"),l(3),o()()),r&2){let e=d();c(3),P(e.error)}}function Je(r,t){if(r&1&&(a(0,"div",12)(1,"div",13)(2,"span"),l(3,"Parsing GPX..."),o(),a(4,"span"),l(5),o()(),a(6,"div",14),x(7,"div",15),o()()),r&2){let e=d();c(5),q("",e.readingProgress??100,"%"),c(2),he("width",e.readingProgress??100,"%")}}function Qe(r,t){if(r&1){let e=y();a(0,"div",16)(1,"h4"),l(2,"Content Preview"),o(),a(3,"div",17)(4,"label",18)(5,"input",19),_("change",function(i){u(e);let s=d();return g(s.toggleSelection("waypoints",i))}),o(),a(6,"span",20),l(7,"Waypoints"),o(),a(8,"span",21),l(9),o()(),a(10,"label",18)(11,"input",19),_("change",function(i){u(e);let s=d();return g(s.toggleSelection("routes",i))}),o(),a(12,"span",20),l(13,"Routes"),o(),a(14,"span",21),l(15),o()(),a(16,"label",18)(17,"input",19),_("change",function(i){u(e);let s=d();return g(s.toggleSelection("tracks",i))}),o(),a(18,"span",20),l(19,"Tracks"),o(),a(20,"span",21),l(21),o()()(),a(22,"div",22)(23,"app-button",23),_("click",function(){u(e);let i=d();return g(i.cancel())}),l(24,"Cancel"),o(),a(25,"app-button",24),_("click",function(){u(e);let i=d();return g(i.confirm())}),l(26),o()()()}if(r&2){let e=d();c(4),T("disabled",e.parseResult.waypoints.length===0),c(),m("checked",e.selected.waypoints)("disabled",e.parseResult.waypoints.length===0),c(4),P(e.parseResult.waypoints.length),c(),T("disabled",e.parseResult.routes.length===0),c(),m("checked",e.selected.routes)("disabled",e.parseResult.routes.length===0),c(4),P(e.parseResult.routes.length),c(),T("disabled",e.parseResult.tracks.length===0),c(),m("checked",e.selected.tracks)("disabled",e.parseResult.tracks.length===0),c(4),P(e.parseResult.tracks.length),c(4),m("disabled",e.selectedCount===0||e.isImporting||e.isParsing),c(),q(" Import ",e.selectedCount," Items ")}}var le=class r{importData=new R;cancelImport=new R;maxFileSize=10*1024*1024;dragging=!1;error=null;parseResult=null;readingProgress=null;isParsing=!1;isImporting=!1;selected={waypoints:!0,routes:!0,tracks:!0};onDragOver(t){t.preventDefault(),this.dragging=!0}onDragLeave(t){t.preventDefault(),this.dragging=!1}onDrop(t){if(t.preventDefault(),this.dragging=!1,this.error=null,t.dataTransfer?.files?.length){let e=t.dataTransfer.files[0];e&&this.readFile(e)}}onFileSelected(t){let e=t.target;if(e.files?.length){let n=e.files[0];n&&this.readFile(n)}}readFile(t){if(t.size>this.maxFileSize){this.error="File too large. Maximum size is 10MB.";return}if(!t.name.toLowerCase().endsWith(".gpx")){this.error="Invalid GPX file.";return}this.parseResult=null,this.readingProgress=0,this.isParsing=!1,this.error=null;let e=new FileReader;e.onprogress=n=>{n.lengthComputable&&(this.readingProgress=Math.round(n.loaded/n.total*100))},e.onload=n=>{try{let i=n.target?.result;this.isParsing=!0,this.parseResult=ce.parse(i),this.error=null}catch(i){this.error="Failed to parse GPX file. Is it valid XML?",console.error(i)}finally{this.isParsing=!1,this.readingProgress=100}},e.onerror=()=>{this.error="Error reading file",this.readingProgress=null,this.isParsing=!1},e.readAsText(t)}get selectedCount(){if(!this.parseResult)return 0;let t=0;return this.selected.waypoints&&(t+=this.parseResult.waypoints.length),this.selected.routes&&(t+=this.parseResult.routes.length),this.selected.tracks&&(t+=this.parseResult.tracks.length),t}toggleSelection(t,e){let n=e.target.checked;this.selected=I(S({},this.selected),{[t]:n})}confirm(){if(!this.parseResult)return;this.isImporting=!0;let t={waypoints:this.selected.waypoints?this.parseResult.waypoints:[],routes:this.selected.routes?this.parseResult.routes:[],tracks:this.selected.tracks?this.parseResult.tracks:[]};this.importData.emit(t),this.isImporting=!1}cancel(){this.parseResult=null,this.readingProgress=null,this.isParsing=!1,this.error=null,this.cancelImport.emit()}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=F({type:r,selectors:[["app-gpx-import"]],outputs:{importData:"importData",cancelImport:"cancelImport"},decls:14,vars:5,consts:[["fileInput",""],[1,"gpx-import"],[1,"dropzone",3,"dragover","dragleave","drop"],["name","arrow-up","size","48",1,"upload-icon"],[1,"or"],["type","file","accept",".gpx,application/gpx+xml",2,"display","none",3,"change"],["variant","secondary",3,"click"],["class","error-msg",4,"ngIf"],["class","progress-section",4,"ngIf"],["class","preview-section",4,"ngIf"],[1,"error-msg"],["name","alert-triangle","size","16"],[1,"progress-section"],[1,"progress-row"],[1,"progress-bar"],[1,"progress-fill"],[1,"preview-section"],[1,"preview-list"],[1,"preview-item"],["type","checkbox",3,"change","checked","disabled"],[1,"preview-label"],[1,"preview-count"],[1,"actions"],["variant","ghost",3,"click"],["variant","primary",3,"click","disabled"]],template:function(e,n){if(e&1){let i=y();a(0,"div",1)(1,"div",2),_("dragover",function(p){return u(i),g(n.onDragOver(p))})("dragleave",function(p){return u(i),g(n.onDragLeave(p))})("drop",function(p){return u(i),g(n.onDrop(p))}),x(2,"app-icon",3),a(3,"p"),l(4,"Drag & Drop GPX file here"),o(),a(5,"p",4),l(6,"OR"),o(),a(7,"input",5,0),_("change",function(p){return u(i),g(n.onFileSelected(p))}),o(),a(9,"app-button",6),_("click",function(){u(i);let p=X(8);return g(p.click())}),l(10,"Browse File"),o()(),f(11,Ye,4,1,"div",7)(12,Je,8,3,"div",8)(13,Qe,27,17,"div",9),o()}e&2&&(c(),T("dragging",n.dragging),c(10),m("ngIf",n.error),c(),m("ngIf",n.readingProgress!==null||n.isParsing),c(),m("ngIf",n.parseResult))},dependencies:[L,D,G,H],styles:[".gpx-import[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1.5rem}.dropzone[_ngcontent-%COMP%]{border:2px dashed var(--border);border-radius:8px;padding:3rem;display:flex;flex-direction:column;align-items:center;gap:1rem;background:var(--gb-bg-panel);transition:all .2s}.dropzone.dragging[_ngcontent-%COMP%]{border-color:var(--gb-needle-secondary);background:var(--surface-3)}.upload-icon[_ngcontent-%COMP%]{color:var(--gb-text-muted)}.or[_ngcontent-%COMP%]{font-size:.75rem;color:var(--gb-text-muted);margin:0}.error-msg[_ngcontent-%COMP%]{color:var(--error);background:var(--surface-error);padding:.75rem;border-radius:4px;display:flex;align-items:center;gap:.5rem;font-size:.875rem}.preview-section[_ngcontent-%COMP%]{border-top:1px solid var(--border);padding-top:1rem;animation:_ngcontent-%COMP%_fadeIn .3s ease}h4[_ngcontent-%COMP%]{margin:0 0 1rem;font-size:1rem}.preview-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.75rem;margin-bottom:1.5rem}.preview-item[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:.75rem;padding:.75rem 1rem;border-radius:6px;background:var(--gb-bg-panel);border:1px solid var(--border);font-size:.9rem}.preview-item[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{accent-color:var(--gb-needle-secondary)}.preview-label[_ngcontent-%COMP%]{flex:1;font-weight:600;color:var(--gb-text-value)}.preview-count[_ngcontent-%COMP%]{font-size:.85rem;color:var(--gb-text-muted)}.preview-item.disabled[_ngcontent-%COMP%]{opacity:.5}.actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:1rem}.progress-section[_ngcontent-%COMP%]{border-top:1px solid var(--border);padding-top:1rem}.progress-row[_ngcontent-%COMP%]{display:flex;justify-content:space-between;font-size:.85rem;color:var(--gb-text-muted);margin-bottom:.5rem}.progress-bar[_ngcontent-%COMP%]{height:6px;background:var(--surface-3);border-radius:999px;overflow:hidden}.progress-fill[_ngcontent-%COMP%]{height:100%;background:var(--gb-needle-secondary);transition:width .2s ease}@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}"],changeDetection:0})};var pe=class r{constructor(t){this.skResources=t;this.loadAll()}_routes=new V(new Map);routes$=this._routes.asObservable().pipe(te(t=>Array.from(t.values()).sort((e,n)=>{let i=e.timestamp?new Date(e.timestamp).getTime():0;return(n.timestamp?new Date(n.timestamp).getTime():0)-i})));_loading=new V(!1);loading$=this._loading.asObservable();loadAll(){this._loading.next(!0),this.skResources.getResources("routes").subscribe({next:t=>{let e=new Map;if(t)for(let[n,i]of Object.entries(t))e.set(n,this.withLegs(I(S({},i),{id:n})));this._routes.next(e),this._loading.next(!1)},error:t=>{console.error("Failed to load routes",t),this._loading.next(!1)}})}createRoute(t){let e=this.stripInternal(t);this.skResources.createResource("routes",e).subscribe({next:n=>{let i=n.id,s=this.withLegs(I(S({},t),{id:i,timestamp:new Date().toISOString()})),p=this._routes.value,b=new Map(p);b.set(i,s),this._routes.next(b)},error:n=>console.error("Failed to create route",n)})}updateRoute(t,e){let n=this._routes.value,i=n.get(t);if(!i)return;let s=this.withLegs(I(S(S({},i),e),{timestamp:new Date().toISOString()})),p=new Map(n);p.set(t,s),this._routes.next(p);let b=this.stripInternal(s);this.skResources.setResource("routes",t,b).subscribe({error:w=>{console.error("Failed to update route",w);let k=new Map(this._routes.value);k.set(t,i),this._routes.next(k)}})}deleteRoute(t){let e=this._routes.value;if(!e.has(t))return;let n=new Map(e);n.delete(t),this._routes.next(n),this.skResources.deleteResource("routes",t).subscribe({error:i=>{console.error("Failed to delete route",i);let s=new Map(this._routes.value),p=e.get(t);p&&s.set(t,p),this._routes.next(s)}})}getRoute(t){return this._routes.value.get(t)}withLegs(t){let e=this.extractCoordinates(t.feature);if(e.length<2)return I(S({},t),{legs:[],totalDistanceNm:0});let n=[],i=0;for(let s=0;s<e.length-1;s++){let p=e[s],b=e[s+1];if(!p||!b)continue;let[w,k]=p,[C,v]=b,h=De({lat:k,lon:w},{lat:v,lon:C});i+=h.distanceNm,n.push({from:{latitude:k,longitude:w},to:{latitude:v,longitude:C},bearingDeg:h.bearingDeg,distanceNm:h.distanceNm})}return I(S({},t),{legs:n,totalDistanceNm:t.totalDistanceNm??i})}extractCoordinates(t){if(!t||typeof t!="object")return[];let e=t.geometry;return e?e.type==="LineString"&&Array.isArray(e.coordinates)?this.coerceLine(e.coordinates):e.type==="MultiLineString"&&Array.isArray(e.coordinates)?e.coordinates.flatMap(i=>this.coerceLine(i)):[]:[]}coerceLine(t){if(!Array.isArray(t))return[];let e=[];for(let n of t){if(!Array.isArray(n)||n.length<2)continue;let[i,s]=n;typeof i!="number"||typeof s!="number"||!Number.isFinite(s)||!Number.isFinite(i)||e.push([i,s])}return e}stripInternal(t){let p=t,{id:e,legs:n,totalDistanceNm:i}=p;return ve(p,["id","legs","totalDistanceNm"])}static \u0275fac=function(e){return new(e||r)(ee(oe))};static \u0275prov=K({token:r,factory:r.\u0275fac,providedIn:"root"})};var de=class r{constructor(t,e){this.datapointStore=t;this.skResources=e;this.loadAll()}maxTrackPoints=1e4;_recording=new V(!1);recording$=this._recording.asObservable();_currentTrack=[];_currentTrackSubject=new V([]);currentTrack$=this._currentTrackSubject.asObservable();_tracks=new V(new Map);tracks$=this._tracks.asObservable().pipe(te(t=>Array.from(t.values()).sort((e,n)=>{let i=e.timestamp?new Date(e.timestamp).getTime():0;return(n.timestamp?new Date(n.timestamp).getTime():0)-i})));_loading=new V(!1);loading$=this._loading.asObservable();sub=null;ngOnDestroy(){this.stopRecording()}startRecording(){this._recording.value||(this._currentTrack=[],this._currentTrackSubject.next([]),this._recording.next(!0),this.sub=this.datapointStore.observe(We.navigation.position).pipe(xe(t=>!!t&&typeof t.value=="object"&&t.value!==null&&typeof t.value.latitude=="number"&&typeof t.value.longitude=="number")).subscribe(t=>{let e={lat:t.value.latitude,lon:t.value.longitude,ts:t.timestamp};this._currentTrack.push(e),this._currentTrackSubject.next([...this._currentTrack])}))}stopRecording(){this._recording.value&&(this._recording.next(!1),this.sub&&(this.sub.unsubscribe(),this.sub=null))}saveTrack(t){if(this._currentTrack.length<2)return;let e=this._currentTrack[0],n=this._currentTrack[this._currentTrack.length-1];if(!e||!n)return;let i=t?.trim()||`Track ${new Date().toISOString()}`,s=this.getTrackCoordinates(),p={name:i,feature:{type:"Feature",geometry:{type:"LineString",coordinates:s},properties:{startTime:new Date(e.ts).toISOString(),endTime:new Date(n.ts).toISOString()}}};this.skResources.createResource("tracks",p).subscribe({next:b=>{let w=b.id,k=I(S({},p),{id:w,timestamp:new Date().toISOString()}),C=this._tracks.value,v=new Map(C);v.set(w,k),this._tracks.next(v),console.log("Track saved successfully"),this._currentTrack=[],this._currentTrackSubject.next([])},error:b=>console.error("Failed to save track",b)})}discardTrack(){this._currentTrack=[],this._currentTrackSubject.next([]),this._recording.value&&this.stopRecording()}deleteTrack(t){let e=this._tracks.value;if(!e.has(t))return;let n=new Map(e),i=e.get(t);n.delete(t),this._tracks.next(n),this.skResources.deleteResource("tracks",t).subscribe({error:s=>{if(console.error("Failed to delete track",s),i){let p=new Map(this._tracks.value);p.set(t,i),this._tracks.next(p)}}})}loadAll(){this._loading.next(!0),this.skResources.getResources("tracks").subscribe({next:t=>{let e=new Map;if(t)for(let[n,i]of Object.entries(t))e.set(n,I(S({},i),{id:n}));this._tracks.next(e),this._loading.next(!1)},error:t=>{console.error("Failed to load tracks",t),this._loading.next(!1)}})}getTrackCoordinates(){let t=this._currentTrack;if(t.length<=this.maxTrackPoints)return t.map(s=>[s.lon,s.lat]);let e=Math.ceil(t.length/this.maxTrackPoints),n=[];for(let s=0;s<t.length;s+=e){let p=t[s];p&&n.push([p.lon,p.lat])}let i=t[t.length-1];return i&&(n[n.length-1]?.[0]!==i.lon||n[n.length-1]?.[1]!==i.lat)&&n.push([i.lon,i.lat]),n}static \u0275fac=function(e){return new(e||r)(ee(Le),ee(oe))};static \u0275prov=K({token:r,factory:r.\u0275fac,providedIn:"root"})};var me=class r{waypointStore=ne(Ae);routeStore=ne(pe);trackStore=ne(de);waypoints$=this.waypointStore.waypoints$;routes$=this.routeStore.routes$;isRecordingTrack$=this.trackStore.recording$;currentTrack$=this.trackStore.currentTrack$;tracks$=this.trackStore.tracks$;createWaypoint(t){let e={name:t.name,position:{latitude:t.lat,longitude:t.lon}};t.description&&(e.description=t.description),this.waypointStore.createWaypoint(e).subscribe({error:n=>console.error("Failed to create waypoint",n)})}updateWaypoint(t,e){this.waypointStore.updateWaypoint(t,{name:e.name,description:e.description,position:{latitude:e.lat,longitude:e.lon}})}deleteWaypoint(t){this.waypointStore.deleteWaypoint(t)}deleteRoute(t){this.routeStore.deleteRoute(t)}startTrackRecording(){this.trackStore.startRecording()}stopTrackRecording(){this.trackStore.stopRecording()}saveTrack(t){this.trackStore.saveTrack(t)}discardTrack(){this.trackStore.discardTrack()}deleteTrack(t){this.trackStore.deleteTrack(t)}importGpx(t){for(let e of t.waypoints){let n={name:e.name||"Imported Waypoint",position:{latitude:e.lat,longitude:e.lon}};e.desc&&(n.description=e.desc),this.waypointStore.createWaypoint(n).subscribe({error:i=>console.error("Failed to import waypoint",i)})}console.log("Routes import not fully implemented in facade logic yet")}static \u0275fac=function(e){return new(e||r)};static \u0275prov=K({token:r,factory:r.\u0275fac,providedIn:"root"})};function tt(r,t){if(r&1){let e=y();a(0,"app-button",8),_("click",function(){u(e);let i=d();return g(i.viewMode="import")}),x(1,"app-icon",9),l(2," Import GPX "),o()}}function nt(r,t){if(r&1){let e=y();a(0,"div",10)(1,"button",11),_("click",function(){u(e);let i=d();return g(i.activeTab="waypoints")}),l(2,"Waypoints"),o(),a(3,"button",11),_("click",function(){u(e);let i=d();return g(i.activeTab="routes")}),l(4,"Routes"),o(),a(5,"button",11),_("click",function(){u(e);let i=d();return g(i.activeTab="tracks")}),l(6,"Tracks"),o()()}if(r&2){let e=d();c(),T("active",e.activeTab==="waypoints"),c(2),T("active",e.activeTab==="routes"),c(2),T("active",e.activeTab==="tracks")}}function it(r,t){if(r&1){let e=y();M(0),a(1,"app-waypoint-list",18),_("edit",function(i){let s=u(e).ngIf,p=d(3);return g(p.startEditWaypoint(i,s))})("delete",function(i){u(e);let s=d(3);return g(s.facade.deleteWaypoint(i))}),o(),E()}if(r&2){let e=t.ngIf;c(),m("waypoints",e)}}function rt(r,t){if(r&1){let e=y();a(0,"div",14)(1,"div",15)(2,"app-button",16),_("click",function(){u(e);let i=d(2);return g(i.startCreateWaypoint())}),x(3,"app-icon",17),l(4," New Waypoint "),o()(),f(5,it,2,1,"ng-container",7),N(6,"async"),o()}if(r&2){let e=d(2);c(5),m("ngIf",W(6,1,e.facade.waypoints$))}}function ot(r,t){if(r&1){let e=y();a(0,"div",19)(1,"h3"),l(2),o(),a(3,"app-waypoint-form",20),_("save",function(i){u(e);let s=d(2);return g(s.handleSaveWaypoint(i))})("cancel",function(){u(e);let i=d(2);return g(i.viewMode="list")}),o()()}if(r&2){let e=d(2);c(2),P(e.viewMode==="create-waypoint"?"Create Waypoint":"Edit Waypoint"),c(),m("initialValue",e.editingWaypointFormValue)("editMode",e.viewMode==="edit-waypoint")}}function at(r,t){if(r&1&&(M(0),f(1,rt,7,3,"div",12)(2,ot,4,3,"div",13),E()),r&2){let e=d();c(),m("ngIf",e.viewMode==="list"),c(),m("ngIf",e.viewMode==="create-waypoint"||e.viewMode==="edit-waypoint")}}function st(r,t){if(r&1){let e=y();a(0,"div",14)(1,"div",21)(2,"p"),l(3,"Route management coming soon..."),o(),a(4,"app-button",8),_("click",function(){u(e);let i=d(2);return g(i.activeTab="waypoints")}),l(5,"Go to Waypoints"),o()()()}}function ct(r,t){if(r&1&&(M(0),f(1,st,6,0,"div",12),E()),r&2){let e=d();c(),m("ngIf",e.viewMode==="list")}}function lt(r,t){if(r&1){let e=y();a(0,"app-button",28),_("click",function(){u(e);let i=d(4);return g(i.facade.startTrackRecording())}),l(1,"Start Recording"),o()}}function pt(r,t){if(r&1){let e=y();a(0,"app-button",8),_("click",function(){u(e);let i=d(4);return g(i.facade.stopTrackRecording())}),l(1,"Stop"),o()}}function dt(r,t){if(r&1){let e=y();a(0,"app-button",29),_("click",function(){u(e);let i=d(4);return g(i.facade.discardTrack())}),l(1,"Discard"),o()}}function mt(r,t){if(r&1&&(M(0),a(1,"div",22)(2,"div",23),x(3,"span",24),a(4,"span"),l(5),o()(),a(6,"div",25),f(7,lt,2,0,"app-button",26)(8,pt,2,0,"app-button",4)(9,dt,2,0,"app-button",27),o()(),E()),r&2){let e=t.ngIf;c(3),T("active",e),c(2),P(e?"Recording track...":"Not recording"),c(2),m("ngIf",!e),c(),m("ngIf",e),c(),m("ngIf",e)}}function ut(r,t){if(r&1){let e=y();a(0,"div",31)(1,"div",32)(2,"div",33),l(3),o()(),a(4,"div",34)(5,"input",35),_("input",function(i){u(e);let s=d(4);return g(s.onTrackNameInput(i))}),o(),a(6,"app-button",36),_("click",function(){u(e);let i=d(4);return g(i.saveTrack())}),l(7,"Save Track"),o(),a(8,"app-button",29),_("click",function(){u(e);let i=d(4);return g(i.facade.discardTrack())}),l(9,"Discard"),o()()()}if(r&2){let e=d().ngIf,n=d(3);c(3),q("",e.length," points captured"),c(2),m("value",n.trackName),c(),m("disabled",!n.trackName.trim())}}function gt(r,t){if(r&1&&(M(0),f(1,ut,10,3,"div",30),E()),r&2){let e=t.ngIf;c(),m("ngIf",e.length>1)}}function _t(r,t){if(r&1){let e=y();a(0,"div",40)(1,"div",41)(2,"div",42),l(3),o(),a(4,"div",43),l(5),o()(),a(6,"app-button",44),_("click",function(){let i=u(e).$implicit,s=d(5);return g(s.facade.deleteTrack(i.id))}),x(7,"app-icon",45),o()()}if(r&2){let e=t.$implicit,n=d(5);c(3),P(e.name||"Unnamed track"),c(2),q("",n.trackPointCount(e)," pts")}}function ft(r,t){if(r&1&&(a(0,"div",38),f(1,_t,8,2,"div",39),o()),r&2){let e=d().ngIf,n=d(3);c(),m("ngForOf",e)("ngForTrackBy",n.trackByTrackId)}}function vt(r,t){r&1&&(a(0,"div",21),l(1,"No saved tracks yet."),o())}function xt(r,t){if(r&1&&(M(0),f(1,ft,2,2,"div",37)(2,vt,2,0,"ng-template",null,0,ie),E()),r&2){let e=t.ngIf,n=X(3);c(),m("ngIf",e.length>0)("ngIfElse",n)}}function yt(r,t){if(r&1&&(a(0,"div",14),f(1,mt,10,6,"ng-container",7),N(2,"async"),f(3,gt,2,1,"ng-container",7),N(4,"async"),f(5,xt,4,2,"ng-container",7),N(6,"async"),o()),r&2){let e=d(2);c(),m("ngIf",W(2,3,e.facade.isRecordingTrack$)),c(2),m("ngIf",W(4,5,e.facade.currentTrack$)),c(2),m("ngIf",W(6,7,e.facade.tracks$))}}function bt(r,t){if(r&1&&(M(0),f(1,yt,7,9,"div",12),E()),r&2){let e=d();c(),m("ngIf",e.viewMode==="list")}}function ht(r,t){if(r&1){let e=y();M(0),a(1,"div",19)(2,"h3"),l(3,"Import GPX"),o(),a(4,"app-gpx-import",46),_("importData",function(i){u(e);let s=d();return g(s.handleImport(i))})("cancelImport",function(){u(e);let i=d();return g(i.viewMode="list")}),o()(),E()}}var je=class r{constructor(t){this.facade=t}activeTab="waypoints";viewMode="list";trackName="";editingWaypointId=null;editingWaypointFormValue=null;startCreateWaypoint(){this.editingWaypointId=null,this.editingWaypointFormValue=null,this.viewMode="create-waypoint"}startEditWaypoint(t,e){let n=e.find(s=>s.id===t),i=this.getWaypointPosition(n);i&&n&&(this.editingWaypointId=t,this.editingWaypointFormValue={name:n.name||"",description:n.description||"",lat:i.latitude,lon:i.longitude,icon:"crosshair",color:"#000000"},this.viewMode="edit-waypoint")}handleSaveWaypoint(t){this.viewMode==="create-waypoint"?this.facade.createWaypoint(t):this.viewMode==="edit-waypoint"&&this.editingWaypointId&&this.facade.updateWaypoint(this.editingWaypointId,t),this.viewMode="list"}handleImport(t){this.facade.importGpx(t),this.viewMode="list"}saveTrack(){this.trackName.trim()&&(this.facade.saveTrack(this.trackName.trim()),this.trackName="")}onTrackNameInput(t){let e=t.target?.value??"";this.trackName=e}trackByTrackId(t,e){return e.id}trackPointCount(t){let e=t.feature?.geometry;return e?e.type==="LineString"&&Array.isArray(e.coordinates)?e.coordinates.length:e.type==="MultiLineString"&&Array.isArray(e.coordinates)?e.coordinates.reduce((n,i)=>n+(Array.isArray(i)?i.length:0),0):0:0}getWaypointPosition(t){if(!t)return null;if(t.position&&Number.isFinite(t.position.latitude)&&Number.isFinite(t.position.longitude))return t.position;let n=t.feature?.geometry;if(!n||n.type!=="Point"||!Array.isArray(n.coordinates))return null;let i=n.coordinates;if(i.length<2)return null;let s=i[0],p=i[1];return typeof p!="number"||typeof s!="number"||!Number.isFinite(p)||!Number.isFinite(s)?null:{latitude:p,longitude:s}}static \u0275fac=function(e){return new(e||r)(be(me))};static \u0275cmp=F({type:r,selectors:[["app-resources-page"]],decls:12,vars:6,consts:[["noTracks",""],[1,"page-container"],[1,"page-header"],[1,"header-actions"],["variant","secondary",3,"click",4,"ngIf"],["class","tabs",4,"ngIf"],[1,"content-area"],[4,"ngIf"],["variant","secondary",3,"click"],["name","arrow-up","size","18"],[1,"tabs"],[1,"tab-btn",3,"click"],["class","tab-content",4,"ngIf"],["class","form-container",4,"ngIf"],[1,"tab-content"],[1,"tab-actions"],[3,"click"],["name","plus","size","18"],[3,"edit","delete","waypoints"],[1,"form-container"],[3,"save","cancel","initialValue","editMode"],[1,"empty-state"],[1,"track-controls"],[1,"track-status"],[1,"status-dot"],[1,"track-actions"],["variant","primary",3,"click",4,"ngIf"],["variant","ghost",3,"click",4,"ngIf"],["variant","primary",3,"click"],["variant","ghost",3,"click"],["class","track-save",4,"ngIf"],[1,"track-save"],[1,"track-save-info"],[1,"track-points"],[1,"track-save-actions"],["placeholder","Track name",1,"input-control",3,"input","value"],["variant","primary",3,"click","disabled"],["class","track-list",4,"ngIf","ngIfElse"],[1,"track-list"],["class","track-row",4,"ngFor","ngForOf","ngForTrackBy"],[1,"track-row"],[1,"track-info"],[1,"track-name"],[1,"track-meta"],["variant","ghost","title","Delete",3,"click"],["name","trash","size","16"],[3,"importData","cancelImport"]],template:function(e,n){e&1&&(a(0,"div",1)(1,"header",2)(2,"h1"),l(3,"Resources"),o(),a(4,"div",3),f(5,tt,3,0,"app-button",4),o()(),f(6,nt,7,6,"div",5),a(7,"div",6),f(8,at,3,2,"ng-container",7)(9,ct,2,1,"ng-container",7)(10,bt,2,1,"ng-container",7)(11,ht,5,0,"ng-container",7),o()()),e&2&&(c(5),m("ngIf",n.viewMode==="list"),c(),m("ngIf",n.viewMode==="list"),c(2),m("ngIf",n.activeTab==="waypoints"),c(),m("ngIf",n.activeTab==="routes"),c(),m("ngIf",n.activeTab==="tracks"),c(),m("ngIf",n.viewMode==="import"))},dependencies:[L,re,D,ae,se,le,G,H,ke],styles:[".page-container[_ngcontent-%COMP%]{padding:1.5rem;height:100%;display:flex;flex-direction:column;gap:1.5rem;max-width:800px;margin:0 auto}.page-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}h1[_ngcontent-%COMP%]{margin:0;font-size:1.75rem}h3[_ngcontent-%COMP%]{margin-bottom:1.5rem}.tabs[_ngcontent-%COMP%]{display:flex;gap:1rem;border-bottom:1px solid var(--border)}.tab-btn[_ngcontent-%COMP%]{background:none;border:none;padding:.75rem 1.5rem;font-size:1rem;cursor:pointer;color:var(--gb-text-muted);border-bottom:2px solid transparent}.tab-btn.active[_ngcontent-%COMP%]{color:var(--gb-needle-secondary);border-bottom-color:var(--gb-needle-secondary);font-weight:500}.content-area[_ngcontent-%COMP%]{flex:1;overflow-y:auto}.tab-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;margin-bottom:1rem}.form-container[_ngcontent-%COMP%]{background:var(--gb-bg-bezel);padding:1.5rem;border-radius:8px;border:1px solid var(--border)}.empty-state[_ngcontent-%COMP%]{text-align:center;padding:4rem;color:var(--gb-text-muted)}.track-controls[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:1rem;padding:1rem;border:1px solid var(--border);border-radius:8px;background:var(--gb-bg-bezel);margin-bottom:1.5rem}.track-status[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;color:var(--gb-text-muted);font-size:.9rem}.status-dot[_ngcontent-%COMP%]{width:10px;height:10px;border-radius:999px;background:var(--border)}.status-dot.active[_ngcontent-%COMP%]{background:var(--danger);box-shadow:0 0 0 4px #dc262633}.track-actions[_ngcontent-%COMP%]{display:flex;gap:.5rem;flex-wrap:wrap}.track-save[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.75rem;padding:1rem;border-radius:8px;border:1px solid var(--border);background:var(--gb-bg-bezel);margin-bottom:1.5rem}.track-save-actions[_ngcontent-%COMP%]{display:flex;gap:.5rem;flex-wrap:wrap}.track-save-actions[_ngcontent-%COMP%]   .input-control[_ngcontent-%COMP%]{flex:1;min-width:200px;padding:.65rem .75rem;border-radius:6px;border:1px solid var(--border);background:var(--gb-bg-panel);color:var(--gb-text-value)}.track-points[_ngcontent-%COMP%]{font-size:.9rem;color:var(--gb-text-muted)}.track-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.75rem}.track-row[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:1rem;padding:.75rem 1rem;border-radius:8px;background:var(--gb-bg-panel);border:1px solid var(--border)}.track-info[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.track-name[_ngcontent-%COMP%]{font-weight:600;color:var(--gb-text-value)}.track-meta[_ngcontent-%COMP%]{font-size:.8rem;color:var(--gb-text-muted)}"]})};export{je as ResourcesPage};
