import{a as D,n as le}from"./chunk-MQVH6ZV5.js";import{$ as Y,Bb as v,Ca as q,Cc as re,Hc as ae,J,Jb as te,Ka as d,Lc as ie,Mc as oe,Nb as i,Ob as A,P as H,Pb as h,Qb as ne,Qc as V,X as K,Ya as Q,aa as O,bb as C,bc as b,cc as F,dc as x,fa as I,g as G,ga as E,hb as N,nb as w,ob as a,pb as r,q as B,qb as X,r as W,ub as Z,vb as ee,xb as R,zb as T}from"./chunk-V4EMFQCR.js";import"./chunk-EQDQRRRY.js";function ce(t,n="Unknown"){let e=t.split(/\r?\n/).map(p=>p.trim()).filter(p=>p.length>0&&!p.startsWith("#"));if(e.length<2)throw new Error("Polar CSV must have at least a header and one data row");let m=e[0].split(/[,;\t]+/).map(p=>p.trim()).slice(1).map(Number).filter(Number.isFinite);if(m.length===0)throw new Error("No valid TWS values found in polar header");let c=[],s=[];for(let p=0;p<m.length;p++)s.push([]);for(let p=1;p<e.length;p++){let P=e[p].split(/[,;\t]+/).map(f=>f.trim()),_=Number(P[0]);if(Number.isFinite(_)){c.push(_);for(let f=0;f<m.length;f++){let M=Number(P[f+1])||0;s[f].push(M)}}}let g=me(c,s,"upwind"),u=me(c,s,"downwind");return{vesselName:n,twaValues:c,twsValues:m,data:s,twaBeats:g,twaGybes:u}}function j(t,n,e){let l=Math.abs(e),o=U(t.twsValues,n),m=U(t.twaValues,l);if(o===null||m===null)return 0;let[c,s,g]=o,[u,p,P]=m,_=t.data[c]?.[u]??0,f=t.data[c]?.[p]??0,M=t.data[s]?.[u]??0,$=t.data[s]?.[p]??0,S=_+(f-_)*P,y=M+($-M)*P;return S+(y-S)*g}function k(t,n,e){let l=e==="upwind"?t.twaBeats:t.twaGybes,o=U(t.twsValues,n);if(o===null||l.length===0)return e==="upwind"?45:135;let[m,c,s]=o,g=l[m]??(e==="upwind"?45:135),u=l[c]??g;return g+(u-g)*s}function U(t,n){if(t.length===0)return null;if(n<=t[0])return[0,0,0];if(n>=t[t.length-1])return[t.length-1,t.length-1,0];for(let e=0;e<t.length-1;e++)if(n>=t[e]&&n<=t[e+1]){let l=t[e+1]-t[e],o=l>0?(n-t[e])/l:0;return[e,e+1,o]}return null}function me(t,n,e){let l=[];for(let o=0;o<n.length;o++){let m=0,c=e==="upwind"?45:135;for(let s=0;s<t.length;s++){let g=t[s],u=n[o]?.[s]??0;if(e==="upwind"&&g>90||e==="downwind"&&g<90)continue;let p=Math.abs(u*Math.cos(g*Math.PI/180));p>m&&(m=p,c=g)}l.push(c)}return l}var L="omi-polar-diagram",z=class t{constructor(n){this.platformId=n;V(this.platformId)&&this.restorePolar()}store=O(le);_polar=new G(null);polar$=this._polar.asObservable();hasPolar$=this._polar.pipe(B(n=>n!==null));sow$=this.store.observe(D.navigation.speedThroughWater);twa$=this.store.observe(D.environment.wind.angleTrueWater);tws$=this.store.observe(D.environment.wind.speedTrue);performance$=W([this.sow$,this.twa$,this.tws$,this._polar]).pipe(B(([n,e,l,o])=>{let m=this.numVal(n?.value),c=this.numVal(e?.value),s=this.numVal(l?.value),g=m!==null&&c!==null?m*Math.cos(c*Math.PI/180):null;if(!o||s===null||c===null)return{hasPolar:o!==null,vmgUpwind:null,vmgDownwind:null,currentVmg:g,targetTwa:null,polarTarget:null,polarRatio:null,recommendation:null};let u=j(o,s,c),p=m!==null&&u>0?m/u*100:null,P=Math.abs(c)<90,_=k(o,s,P?"upwind":"downwind"),f=j(o,s,_),M=f*Math.cos(k(o,s,"upwind")*Math.PI/180),$=f*Math.cos(k(o,s,"downwind")*Math.PI/180),S=null;if(c!==null){let y=_-Math.abs(c);Math.abs(y)>2&&(S=y>0?`Bear away ${Math.round(y)}\xB0`:`Head up ${Math.round(Math.abs(y))}\xB0`)}return{hasPolar:!0,vmgUpwind:Math.abs(M),vmgDownwind:Math.abs($),currentVmg:g,targetTwa:_,polarTarget:u,polarRatio:p,recommendation:S}}),J((n,e)=>JSON.stringify(n)===JSON.stringify(e)),H({bufferSize:1,refCount:!0}));get snapshot(){return this._polar.value}setPolar(n){this._polar.next(n),this.persistPolar(n)}clearPolar(){this._polar.next(null),V(this.platformId)&&localStorage.removeItem(L)}restorePolar(){try{let n=localStorage.getItem(L);if(!n)return;let e=JSON.parse(n);e&&Array.isArray(e.twaValues)&&Array.isArray(e.twsValues)&&this._polar.next(e)}catch(n){}}persistPolar(n){try{V(this.platformId)&&localStorage.setItem(L,JSON.stringify(n))}catch(e){}}numVal(n){return typeof n=="number"&&Number.isFinite(n)?n:null}static \u0275fac=function(e){return new(e||t)(Y(q))};static \u0275prov=K({token:t,factory:t.\u0275fac,providedIn:"root"})};function de(t,n){if(t&1&&(a(0,"div",12)(1,"h3"),i(2,"Current VMG"),r(),a(3,"div",13)(4,"span",14),i(5),b(6,"number"),r(),a(7,"span",15),i(8,"kts"),r()()()),t&2){let e=v(2).ngIf;d(5),A(x(6,1,e.currentVmg,"1.1-1"))}}function ge(t,n){if(t&1){let e=R();a(0,"div",6)(1,"div",7)(2,"span",8),i(3,"\u{1F4CA}"),r(),a(4,"h2"),i(5,"No Polar Diagram Loaded"),r(),a(6,"p"),i(7," Import a polar diagram (CSV format) to enable performance tracking. Polars define your vessel's target speed at each wind angle and speed. "),r(),a(8,"label",9),i(9," Import Polar CSV "),a(10,"input",10),T("change",function(o){I(e);let m=v(2);return E(m.onPolarFileSelected(o))}),r()()(),C(11,de,9,4,"div",11),r()}if(t&2){let e=v().ngIf;d(11),w("ngIf",e.currentVmg!==null)}}function ue(t,n){if(t&1&&(a(0,"span"),i(1),b(2,"number"),r()),t&2){let e=v(2).ngIf;d(),h(" Target: ",x(2,1,e.polarTarget,"1.1-1")," kts ")}}function fe(t,n){if(t&1&&(a(0,"div",40),i(1),r()),t&2){let e=v(2).ngIf;d(),h(" \u{1F4A1} ",e.recommendation," ")}}function ve(t,n){if(t&1&&(a(0,"div",41)(1,"p")(2,"strong"),i(3),r()(),a(4,"p"),i(5),r()()),t&2){let e=n.ngIf;d(3),A(e.vesselName),d(2),ne("",e.twsValues.length," wind speeds \xD7 ",e.twaValues.length," angles")}}function be(t,n){if(t&1){let e=R();a(0,"div",16)(1,"div",17)(2,"h3"),i(3,"VMG"),r(),a(4,"div",18)(5,"div",19)(6,"span",20),i(7,"Current"),r(),a(8,"span",21),i(9),b(10,"number"),r(),a(11,"span",22),i(12,"kts"),r()(),a(13,"div",19)(14,"span",20),i(15,"Upwind Max"),r(),a(16,"span",21),i(17),b(18,"number"),r(),a(19,"span",22),i(20,"kts"),r()(),a(21,"div",19)(22,"span",20),i(23,"Downwind Max"),r(),a(24,"span",21),i(25),b(26,"number"),r(),a(27,"span",22),i(28,"kts"),r()()()(),a(29,"div",23)(30,"h3"),i(31,"Polar Performance"),r(),a(32,"div",24)(33,"span",25),i(34),b(35,"number"),r(),a(36,"span",26),i(37,"%"),r()(),a(38,"div",27),X(39,"div",28),r(),a(40,"div",29),C(41,ue,3,4,"span",3),r()(),a(42,"div",30)(43,"h3"),i(44,"Optimal TWA"),r(),a(45,"div",31)(46,"span",32),i(47),b(48,"number"),r()(),C(49,fe,2,1,"div",33),r(),a(50,"div",34)(51,"h3"),i(52,"Polar Diagram"),r(),C(53,ve,6,3,"div",35),b(54,"async"),a(55,"div",36)(56,"label",37),i(57," Replace Polar "),a(58,"input",38),T("change",function(o){I(e);let m=v(2);return E(m.onPolarFileSelected(o))}),r()(),a(59,"button",39),T("click",function(){I(e);let o=v(2);return E(o.clearPolar())}),i(60," Remove Polar "),r()()()()}if(t&2){let e=v().ngIf,l=v();d(9),h(" ",e.currentVmg!==null?x(10,12,e.currentVmg,"1.1-1"):"---"," "),d(8),h(" ",e.vmgUpwind!==null?x(18,15,e.vmgUpwind,"1.1-1"):"---"," "),d(8),h(" ",e.vmgDownwind!==null?x(26,18,e.vmgDownwind,"1.1-1"):"---"," "),d(8),N("data-level",l.ratioLevel(e.polarRatio)),d(),h(" ",e.polarRatio!==null?x(35,21,e.polarRatio,"1.0-0"):"---"," "),d(5),te("width",e.polarRatio??0,"%"),N("data-level",l.ratioLevel(e.polarRatio)),d(2),w("ngIf",e.polarTarget!==null),d(6),h(" ",e.targetTwa!==null?x(48,24,e.targetTwa,"1.0-0"):"---","\xB0 "),d(2),w("ngIf",e.recommendation),d(4),w("ngIf",F(54,27,l.polar$))}}function _e(t,n){if(t&1&&(Z(0),C(1,ge,12,1,"div",4)(2,be,61,29,"div",5),ee()),t&2){let e=n.ngIf;d(),w("ngIf",!e.hasPolar),d(),w("ngIf",e.hasPolar)}}var se=class t{perfService=O(z);perf$=this.perfService.performance$;polar$=this.perfService.polar$;ratioLevel(n){return n===null?"ok":n>=95?"good":n>=70?"ok":"low"}onPolarFileSelected(n){let l=n.target.files?.[0];if(!l)return;let o=new FileReader;o.onload=()=>{try{let m=o.result,c=ce(m,l.name.replace(/\.[^.]+$/,""));this.perfService.setPolar(c)}catch(m){console.error("[Performance] Failed to parse polar file:",m)}},o.readAsText(l)}clearPolar(){this.perfService.clearPolar()}static \u0275fac=function(e){return new(e||t)};static \u0275cmp=Q({type:t,selectors:[["app-performance-page"]],decls:8,vars:3,consts:[[1,"perf-page"],[1,"page-header"],[1,"subtitle"],[4,"ngIf"],["class","perf-empty",4,"ngIf"],["class","perf-grid",4,"ngIf"],[1,"perf-empty"],[1,"empty-card"],[1,"empty-icon"],["for","polar-upload",1,"import-btn"],["id","polar-upload","type","file","accept",".csv,.pol,.txt","hidden","",3,"change"],["class","metrics-card",4,"ngIf"],[1,"metrics-card"],[1,"metric-row"],[1,"metric-value"],[1,"metric-unit"],[1,"perf-grid"],[1,"perf-card","perf-card--vmg"],[1,"vmg-row"],[1,"vmg-item"],[1,"vmg-label"],[1,"vmg-value"],[1,"vmg-unit"],[1,"perf-card","perf-card--ratio"],[1,"ratio-display"],[1,"ratio-value"],[1,"ratio-unit"],[1,"ratio-bar-track"],[1,"ratio-bar-fill"],[1,"ratio-meta"],[1,"perf-card","perf-card--target"],[1,"target-display"],[1,"target-value"],["class","recommendation",4,"ngIf"],[1,"perf-card","perf-card--manage"],["class","polar-info",4,"ngIf"],[1,"polar-actions"],["for","polar-replace",1,"action-btn"],["id","polar-replace","type","file","accept",".csv,.pol,.txt","hidden","",3,"change"],[1,"action-btn","action-btn--danger",3,"click"],[1,"recommendation"],[1,"polar-info"]],template:function(e,l){e&1&&(a(0,"div",0)(1,"div",1)(2,"h1"),i(3,"Performance"),r(),a(4,"p",2),i(5,"Sailing performance analysis and polar tracking"),r()(),C(6,_e,3,2,"ng-container",3),b(7,"async"),r()),e&2&&(d(6),w("ngIf",F(7,1,l.perf$)))},dependencies:[oe,re,ae,ie],styles:['@charset "UTF-8";[_nghost-%COMP%]{display:block;height:100%;overflow-y:auto;background:var(--bg)}.perf-page[_ngcontent-%COMP%]{padding:1.5rem;max-width:1200px;margin:0 auto}.page-header[_ngcontent-%COMP%]{margin-bottom:2rem}h1[_ngcontent-%COMP%]{font-size:1.75rem;font-weight:700;color:var(--text-1);margin-bottom:.25rem}.subtitle[_ngcontent-%COMP%]{color:var(--text-2);font-size:.95rem}.perf-empty[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1.5rem;align-items:center}.empty-card[_ngcontent-%COMP%]{background:var(--gb-bg-bezel);border:1px dashed var(--border);border-radius:16px;padding:3rem 2rem;text-align:center;max-width:500px;width:100%}.empty-icon[_ngcontent-%COMP%]{font-size:3rem;display:block;margin-bottom:1rem}.empty-card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:1.25rem;color:var(--text-1);margin-bottom:.5rem}.empty-card[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:var(--text-2);font-size:.9rem;line-height:1.5;margin-bottom:1.5rem}.import-btn[_ngcontent-%COMP%], .action-btn[_ngcontent-%COMP%]{display:inline-block;padding:.6rem 1.5rem;background:var(--accent, #5ba4cf);color:#fff;border:none;border-radius:8px;font-weight:600;font-size:.9rem;cursor:pointer;transition:opacity .2s}.import-btn[_ngcontent-%COMP%]:hover, .action-btn[_ngcontent-%COMP%]:hover{opacity:.85}.action-btn--danger[_ngcontent-%COMP%]{background:var(--status-offline, #f06352)}.perf-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem}.perf-card[_ngcontent-%COMP%]{background:var(--gb-bg-bezel);border:1px solid var(--border);border-radius:16px;padding:1.5rem;box-shadow:var(--shadow)}.perf-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--text-2);margin-bottom:1rem;padding-bottom:.5rem;border-bottom:1px solid var(--border)}.vmg-row[_ngcontent-%COMP%]{display:flex;gap:1.5rem;flex-wrap:wrap}.vmg-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.15rem}.vmg-label[_ngcontent-%COMP%]{font-size:.7rem;text-transform:uppercase;color:var(--text-2);letter-spacing:.08em}.vmg-value[_ngcontent-%COMP%]{font-size:1.5rem;font-weight:700;font-family:var(--font-mono, monospace);font-variant-numeric:tabular-nums;color:var(--text-1)}.vmg-unit[_ngcontent-%COMP%]{font-size:.7rem;color:var(--text-2)}.ratio-display[_ngcontent-%COMP%]{display:flex;align-items:baseline;gap:.25rem;margin-bottom:.75rem}.ratio-value[_ngcontent-%COMP%]{font-size:2.5rem;font-weight:700;font-family:var(--font-mono, monospace);font-variant-numeric:tabular-nums;color:var(--text-1)}.ratio-value[data-level=good][_ngcontent-%COMP%]{color:var(--status-online, #2ec25c)}.ratio-value[data-level=ok][_ngcontent-%COMP%]{color:var(--accent, #5ba4cf)}.ratio-value[data-level=low][_ngcontent-%COMP%]{color:#f3b13f}.ratio-unit[_ngcontent-%COMP%]{font-size:1rem;color:var(--text-2)}.ratio-bar-track[_ngcontent-%COMP%]{height:6px;background:var(--gb-bg-panel);border-radius:3px;overflow:hidden;margin-bottom:.5rem}.ratio-bar-fill[_ngcontent-%COMP%]{height:100%;border-radius:3px;transition:width .3s ease;background:var(--accent, #5ba4cf)}.ratio-bar-fill[data-level=good][_ngcontent-%COMP%]{background:var(--status-online, #2ec25c)}.ratio-bar-fill[data-level=low][_ngcontent-%COMP%]{background:#f3b13f}.ratio-meta[_ngcontent-%COMP%]{font-size:.8rem;color:var(--text-2)}.target-display[_ngcontent-%COMP%]{text-align:center;margin-bottom:1rem}.target-value[_ngcontent-%COMP%]{font-size:2.5rem;font-weight:700;font-family:var(--font-mono, monospace);color:var(--text-1)}.recommendation[_ngcontent-%COMP%]{padding:.75rem 1rem;background:#5ba4cf1a;border:1px solid rgba(91,164,207,.3);border-radius:8px;font-size:.9rem;color:var(--text-1);text-align:center}.polar-info[_ngcontent-%COMP%]{margin-bottom:1rem}.polar-info[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:var(--text-2);font-size:.85rem;margin:.25rem 0}.polar-actions[_ngcontent-%COMP%]{display:flex;gap:.75rem;flex-wrap:wrap}.metrics-card[_ngcontent-%COMP%]{background:var(--gb-bg-bezel);border:1px solid var(--border);border-radius:16px;padding:1.5rem;width:100%;max-width:500px;box-shadow:var(--shadow)}.metrics-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--text-2);margin-bottom:.75rem}.metric-row[_ngcontent-%COMP%]{display:flex;align-items:baseline;gap:.35rem}.metric-value[_ngcontent-%COMP%]{font-size:2rem;font-weight:700;font-family:var(--font-mono, monospace);font-variant-numeric:tabular-nums;color:var(--text-1)}.metric-unit[_ngcontent-%COMP%]{font-size:.8rem;color:var(--text-2)}@media(max-width:768px){.perf-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}.perf-page[_ngcontent-%COMP%]{padding:1rem}}'],changeDetection:0})};export{se as PerformancePage};
