import{a as M}from"./chunk-M73UJ2M4.js";import{a as O}from"./chunk-NV5BHWM3.js";import{a as L}from"./chunk-IOWFGKQA.js";import{a as B}from"./chunk-224KP37M.js";import{a as S,e as j,m as R,n as W}from"./chunk-MQVH6ZV5.js";import{$ as I,C as _,Ca as N,H as P,J as F,Q as k,Qc as $,X as v,a as x,aa as f,g as D,q as y,r as d,z as g}from"./chunk-V4EMFQCR.js";import{a as h,b,f as p}from"./chunk-EQDQRRRY.js";var V={status:"idle",currentTime:0,startTime:0,endTime:0,speed:1,events:[]},A=class s{constructor(t){this.historyService=t}stateSubject=new D(h({},V));state$=this.stateSubject.asObservable();dataSubject=new D({});data$=this.dataSubject.asObservable();tickSub=null;ngOnDestroy(){this.stopTick()}load(t){return p(this,null,function*(){let{paths:e,startTime:i,endTime:r}=t;this.updateState({status:"loading",startTime:i,endTime:r,currentTime:i,events:[]});let n={};for(let a of e)n[a]=yield this.historyService.getRange(a,i,r);this.dataSubject.next(n),this.updateState({status:"ready",startTime:i,endTime:r,currentTime:i,events:this.computeGapEvents(n)})})}play(){let t=this.stateSubject.value;t.status!=="playing"&&t.status!=="idle"&&(this.updateState({status:"playing"}),this.startTick())}pause(){this.stateSubject.value.status==="playing"&&(this.updateState({status:"paused"}),this.stopTick())}stop(){let t=this.stateSubject.value;t.status!=="idle"&&(this.stopTick(),this.updateState({status:"ready",currentTime:t.startTime}))}seek(t){let e=this.stateSubject.value,i=Math.max(e.startTime,Math.min(e.endTime,t));this.updateState({currentTime:i})}setSpeed(t){let e=Math.max(.25,Math.min(10,t));this.updateState({speed:e})}setEvents(t){this.updateState({events:t})}frameForPath(t){return this.state$.pipe(y(e=>{let i=this.dataSubject.value[t]||[];if(!i.length)return null;let r=this.findClosestIndex(i,e.currentTime);return i[r]??null}))}startTick(){this.stopTick(),this.tickSub=g(250).subscribe(()=>{let t=this.stateSubject.value;if(t.status!=="playing")return;let e=t.currentTime+250*t.speed;if(e>=t.endTime){this.updateState({currentTime:t.endTime,status:"paused"}),this.stopTick();return}this.updateState({currentTime:e})})}stopTick(){this.tickSub&&(this.tickSub.unsubscribe(),this.tickSub=null)}updateState(t){this.stateSubject.next(h(h({},this.stateSubject.value),t))}computeGapEvents(t,e=3600*1e3){let i=[];for(let o of Object.values(t))for(let c of o)i.push(c.timestamp);if(!i.length)return[];i.sort((o,c)=>o-c);let r=[],n=i[0];if(n===void 0)return[];let a=n;for(let o=1;o<i.length;o+=1){let c=i[o];if(c===void 0)continue;let l=c-a;if(l>=e){let m=Math.round(l/6e4);r.push({time:a+l/2,type:"note",label:`Gap ${m} min`})}a=c}return r}findClosestIndex(t,e){let i=0,r=t.length-1;for(;i<r;){let o=Math.floor((i+r)/2),c=t[o];if(!c)break;c.timestamp<e?i=o+1:r=o}if(i===0)return 0;let n=t[i-1],a=t[i];return!n||!a?Math.max(0,i-1):Math.abs(a.timestamp-e)<Math.abs(n.timestamp-e)?i:i-1}static \u0275fac=function(e){return new(e||s)(I(R))};static \u0275prov=v({token:s,factory:s.\u0275fac,providedIn:"root"})};var w=class s{audioContext=null;activeSource=null;gainNode=null;soundBuffers=new Map;isEnabled=!1;SOUND_FILES={info:"",warning:"assets/sounds/alarm-warning.wav",critical:"assets/sounds/alarm-critical.wav",emergency:"assets/sounds/alarm-mob.wav"};constructor(){this.initAudioContext()}initAudioContext(){return p(this,null,function*(){if(this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination),this.gainNode.gain.value=.8),this.audioContext.state==="suspended")try{yield this.audioContext.resume(),this.isEnabled=!0,console.log("AudioContext resumed successfully")}catch(t){console.warn("AudioContext resume failed (user interaction needed)",t)}else this.isEnabled=!0;this.preloadSounds()})}playAlarm(t){this.isEnabled||this.initAudioContext().catch(()=>{}),this.activeSource&&this.stop();let e=this.SOUND_FILES[t];e&&this.playSound(e,!0)}stop(){if(this.activeSource){try{this.activeSource.stop(),this.activeSource.disconnect()}catch(t){}this.activeSource=null}}setVolume(t){this.gainNode&&(this.gainNode.gain.value=Math.max(0,Math.min(1,t)))}preloadSounds(){return p(this,null,function*(){let t=Object.values(this.SOUND_FILES);for(let e of t)if(!this.soundBuffers.has(e))try{let i=yield this.fetchAudioBuffer(e);i&&this.soundBuffers.set(e,i)}catch(i){console.error(`Failed to load sound: ${e}`,i)}})}playSound(t,e=!1){return p(this,null,function*(){if(!this.audioContext||!this.gainNode)return;let i=this.soundBuffers.get(t);if(!i)try{i=yield this.fetchAudioBuffer(t),i&&this.soundBuffers.set(t,i)}catch(n){console.error(`Could not play sound ${t}`,n);return}if(!i)return;let r=this.audioContext.createBufferSource();r.buffer=i,r.loop=e,r.connect(this.gainNode),r.start(0),this.activeSource=r})}fetchAudioBuffer(t){return p(this,null,function*(){if(this.audioContext)try{let i=yield(yield fetch(t)).arrayBuffer();return yield this.audioContext.decodeAudioData(i)}catch(e){throw new Error(`Fetch error for ${t}: ${e}`)}})}static \u0275fac=function(e){return new(e||s)};static \u0275prov=v({token:s,factory:s.\u0275fac,providedIn:"root"})};var H=1852,E="omi-anchor-watch",q=class s{alarmStore=f(O);datapointStore=f(W);audioService=f(w);aisStore=f(B);alarmSettings=f(M);playbackStore=f(A);platformId=f(N);isBrowser=$(this.platformId);alarms$=this.alarmStore.alarms$;activeAlarms$=this.alarmStore.activeAlarms$;highestSeverity$=this.alarmStore.highestSeverity$;playbackActive$=this.playbackStore.state$.pipe(y(t=>t.status==="ready"||t.status==="playing"||t.status==="paused"),F(),k(!1));sub=new x;shallowActive=!1;batteryActive=!1;gpsLostActive=!1;constructor(){this.restoreAnchorWatchConfig(),this.initAudioSync(),this.initPlaybackSuppression(),this.initAnchorWatch(),this.persistAnchorWatchConfig(),this.initShallowWater(),this.initBatteryLow(),this.initCpaWarning(),this.initGpsLost()}ngOnDestroy(){this.sub.unsubscribe()}acknowledgeAlarm(t){this.alarmStore.acknowledgeAlarm(t)}silenceAlarm(t){this.alarmStore.silenceAlarm(t)}clearAlarm(t){this.alarmStore.clearAlarm(t)}initAudioSync(){this.sub.add(d([this.highestSeverity$,this.playbackActive$]).pipe(P(200)).subscribe(([,t])=>{if(t){this.audioService.stop();return}let e=this.alarmStore._alarms?.value||new Map,i=Array.from(e.values());if(i.find(n=>n.state==="active")){let n=i.filter(c=>c.state==="active"),a=null,o={info:0,warning:1,critical:2,emergency:3};for(let c of n)(!a||o[c.severity]>o[a])&&(a=c.severity);a?this.audioService.playAlarm(a):this.audioService.stop()}else this.audioService.stop()}))}initPlaybackSuppression(){this.sub.add(d([this.playbackActive$,this.alarmStore.activeAlarms$]).subscribe(([t,e])=>{if(t){for(let i of e)(i.state==="active"||i.state==="acknowledged")&&this.alarmStore.silenceAlarm(i.id);this.audioService.stop()}}))}restoreAnchorWatchConfig(){if(!this.isBrowser)return;let t=localStorage.getItem(E);if(t)try{let e=JSON.parse(t);if(!e.active||!e.anchorPosition||!Number.isFinite(e.radius??NaN))return;this.alarmStore.triggerAlarm("anchor-watch","anchor-watch","warning","Anchor Watch Active",{anchorPosition:e.anchorPosition,radius:e.radius,currentDistance:0,setAt:e.setAt??Date.now()})}catch(e){}}persistAnchorWatchConfig(){this.isBrowser&&this.sub.add(this.alarmStore.alarms$.subscribe(t=>{let e=t.find(n=>n.type==="anchor-watch");if(!e||e.state==="cleared"||e.state==="inactive"){localStorage.removeItem(E);return}let i=e.data?.anchorPosition,r=e.data?.radius;!i||!Number.isFinite(r)||localStorage.setItem(E,JSON.stringify({active:!0,anchorPosition:i,radius:r,setAt:e.data?.setAt??e.timestamp}))}))}initAnchorWatch(){this.sub.add(d([this.alarmStore.alarms$.pipe(y(t=>t.find(e=>e.type==="anchor-watch")),_(t=>!!t&&t.state!=="cleared"&&t.state!=="inactive"&&!!t.data?.anchorPosition)),this.datapointStore.observe(S.navigation.position),this.playbackActive$]).pipe(P(1e3)).subscribe(([t,e,i])=>{if(i||!t||!e?.value)return;let r={lat:e.value.latitude,lon:e.value.longitude},n=t.data;if(!n)return;let a=n.anchorPosition,o=n.radius||40,c=j(a,r),l=c>o;l&&t.severity!=="critical"?this.alarmStore.triggerAlarm(t.id,t.type,"critical","ANCHOR DRAG DETECTED",b(h({},t.data),{currentDistance:c})):!l&&t.severity==="critical"?this.alarmStore.triggerAlarm(t.id,t.type,"warning","Anchor Watch Active",b(h({},t.data),{currentDistance:c})):this.alarmStore.triggerAlarm(t.id,t.type,t.severity,t.message,b(h({},t.data),{currentDistance:c}))}))}initShallowWater(){this.sub.add(d([this.datapointStore.observe(S.environment.depth.belowTransducer).pipe(_(t=>t!==void 0&&typeof t.value=="number")),this.alarmSettings.settings$,this.playbackActive$]).subscribe(([t,e,i])=>{if(i)return;let r=t.value,n=e.shallowDepthThreshold,a=e.shallowDepthHysteresis,o=r<=n,c=r>=n+a;if(o){this.shallowActive=!0,this.alarmStore.triggerAlarm("shallow-water","shallow-water","warning",`SHALLOW WATER ${r.toFixed(1)} m`,{threshold:n,value:r});return}if(this.shallowActive&&c){this.shallowActive=!1,this.alarmStore.clearAlarm("shallow-water");return}this.shallowActive&&this.alarmStore.triggerAlarm("shallow-water","shallow-water","warning",`SHALLOW WATER ${r.toFixed(1)} m`,{threshold:n,value:r})}))}initBatteryLow(){this.sub.add(d([this.datapointStore.observe(S.electrical.batteries.house.voltage).pipe(_(t=>t!==void 0&&typeof t.value=="number")),this.alarmSettings.settings$,this.playbackActive$]).subscribe(([t,e,i])=>{if(i)return;let r=t.value,n=e.lowBatteryThreshold,a=e.lowBatteryHysteresis,o=r<=n,c=r>=n+a;if(o){this.batteryActive=!0,this.alarmStore.triggerAlarm("battery-low","battery-low","critical",`LOW BATTERY ${r.toFixed(1)} V`,{threshold:n,value:r});return}if(this.batteryActive&&c){this.batteryActive=!1,this.alarmStore.clearAlarm("battery-low");return}this.batteryActive&&this.alarmStore.triggerAlarm("battery-low","battery-low","critical",`LOW BATTERY ${r.toFixed(1)} V`,{threshold:n,value:r})}))}initCpaWarning(){this.sub.add(d([L(this.aisStore.targets),this.alarmSettings.settings$,this.playbackActive$]).subscribe(([t,e,i])=>{if(i)return;let r=Array.from(t.values());if(r.length===0){this.alarmStore.clearAlarm("cpa-warning");return}let n=e.cpaThresholdNm*H,a=e.cpaTcpaMinutes*60,o=1/0;for(let l of r)typeof l.cpa!="number"||!Number.isFinite(l.cpa)||typeof l.tcpa!="number"||!Number.isFinite(l.tcpa)||l.tcpa<=0||l.tcpa>a||l.cpa>=n||(o=Math.min(o,l.cpa));if(!Number.isFinite(o)){this.alarmStore.clearAlarm("cpa-warning");return}let c=o/H;this.alarmStore.triggerAlarm("cpa-warning","cpa-warning","warning",`COLLISION WARNING (CPA ${c.toFixed(2)} NM)`,{cpaMeters:o,cpaNm:c,thresholdMeters:n,tcpaSeconds:a})}))}initGpsLost(){let t=this.datapointStore.observe(S.navigation.position).pipe(y(e=>e?.timestamp??null),F());this.sub.add(d([t,this.alarmSettings.settings$,g(1e3).pipe(k(0)),this.playbackActive$]).subscribe(([e,i,r,n])=>{if(n)return;let a=i.gpsLostSeconds*1e3,o=i.gpsLostHysteresisSeconds*1e3,c=Date.now(),l=e?c-e:Number.POSITIVE_INFINITY,m=Math.max(0,Math.round(l/1e3)),U=l>=a,Y=l<=Math.max(0,a-o);if(U){this.gpsLostActive=!0,this.alarmStore.triggerAlarm("gps-lost","gps-lost","warning",`GPS LOST (${m}s)`,{ageSeconds:m,thresholdSeconds:i.gpsLostSeconds});return}this.gpsLostActive&&Y?(this.gpsLostActive=!1,this.alarmStore.clearAlarm("gps-lost")):this.gpsLostActive&&this.alarmStore.triggerAlarm("gps-lost","gps-lost","warning",`GPS LOST (${m}s)`,{ageSeconds:m,thresholdSeconds:i.gpsLostSeconds})}))}static \u0275fac=function(e){return new(e||s)};static \u0275prov=v({token:s,factory:s.\u0275fac,providedIn:"root"})};var u=(function(s){return s[s.State=0]="State",s[s.Transition=1]="Transition",s[s.Sequence=2]="Sequence",s[s.Group=3]="Group",s[s.Animate=4]="Animate",s[s.Keyframes=5]="Keyframes",s[s.Style=6]="Style",s[s.Trigger=7]="Trigger",s[s.Reference=8]="Reference",s[s.AnimateChild=9]="AnimateChild",s[s.AnimateRef=10]="AnimateRef",s[s.Query=11]="Query",s[s.Stagger=12]="Stagger",s})(u||{}),Q="*";function J(s,t){return{type:u.Trigger,name:s,definitions:t,options:{}}}function z(s,t=null){return{type:u.Animate,styles:t,timings:s}}function Ct(s,t=null){return{type:u.Sequence,steps:s,options:t}}function X(s){return{type:u.Style,styles:s,offset:null}}function Z(s,t,e=null){return{type:u.Transition,expr:s,animation:t,options:e}}function tt(s,t,e=null){return{type:u.Query,selector:s,animation:t,options:e}}function et(s,t){return{type:u.Stagger,timings:s,animation:t}}var T=class{_onDoneFns=[];_onStartFns=[];_onDestroyFns=[];_originalOnDoneFns=[];_originalOnStartFns=[];_started=!1;_destroyed=!1;_finished=!1;_position=0;parentPlayer=null;totalTime;constructor(t=0,e=0){this.totalTime=t+e}_onFinish(){this._finished||(this._finished=!0,this._onDoneFns.forEach(t=>t()),this._onDoneFns=[])}onStart(t){this._originalOnStartFns.push(t),this._onStartFns.push(t)}onDone(t){this._originalOnDoneFns.push(t),this._onDoneFns.push(t)}onDestroy(t){this._onDestroyFns.push(t)}hasStarted(){return this._started}init(){}play(){this.hasStarted()||(this._onStart(),this.triggerMicrotask()),this._started=!0}triggerMicrotask(){queueMicrotask(()=>this._onFinish())}_onStart(){this._onStartFns.forEach(t=>t()),this._onStartFns=[]}pause(){}restart(){}finish(){this._onFinish()}destroy(){this._destroyed||(this._destroyed=!0,this.hasStarted()||this._onStart(),this.finish(),this._onDestroyFns.forEach(t=>t()),this._onDestroyFns=[])}reset(){this._started=!1,this._finished=!1,this._onStartFns=this._originalOnStartFns,this._onDoneFns=this._originalOnDoneFns}setPosition(t){this._position=this.totalTime?t*this.totalTime:1}getPosition(){return this.totalTime?this._position/this.totalTime:1}triggerCallback(t){let e=t=="start"?this._onStartFns:this._onDoneFns;e.forEach(i=>i()),e.length=0}},C=class{_onDoneFns=[];_onStartFns=[];_finished=!1;_started=!1;_destroyed=!1;_onDestroyFns=[];parentPlayer=null;totalTime=0;players;constructor(t){this.players=t;let e=0,i=0,r=0,n=this.players.length;n==0?queueMicrotask(()=>this._onFinish()):this.players.forEach(a=>{a.onDone(()=>{++e==n&&this._onFinish()}),a.onDestroy(()=>{++i==n&&this._onDestroy()}),a.onStart(()=>{++r==n&&this._onStart()})}),this.totalTime=this.players.reduce((a,o)=>Math.max(a,o.totalTime),0)}_onFinish(){this._finished||(this._finished=!0,this._onDoneFns.forEach(t=>t()),this._onDoneFns=[])}init(){this.players.forEach(t=>t.init())}onStart(t){this._onStartFns.push(t)}_onStart(){this.hasStarted()||(this._started=!0,this._onStartFns.forEach(t=>t()),this._onStartFns=[])}onDone(t){this._onDoneFns.push(t)}onDestroy(t){this._onDestroyFns.push(t)}hasStarted(){return this._started}play(){this.parentPlayer||this.init(),this._onStart(),this.players.forEach(t=>t.play())}pause(){this.players.forEach(t=>t.pause())}restart(){this.players.forEach(t=>t.restart())}finish(){this._onFinish(),this.players.forEach(t=>t.finish())}destroy(){this._onDestroy()}_onDestroy(){this._destroyed||(this._destroyed=!0,this._onFinish(),this.players.forEach(t=>t.destroy()),this._onDestroyFns.forEach(t=>t()),this._onDestroyFns=[])}reset(){this.players.forEach(t=>t.reset()),this._destroyed=!1,this._finished=!1,this._started=!1}setPosition(t){let e=t*this.totalTime;this.players.forEach(i=>{let r=i.totalTime?Math.min(1,e/i.totalTime):1;i.setPosition(r)})}getPosition(){let t=this.players.reduce((e,i)=>e===null||i.totalTime>e.totalTime?i:e,null);return t!=null?t.getPosition():0}beforeDestroy(){this.players.forEach(t=>{t.beforeDestroy&&t.beforeDestroy()})}triggerCallback(t){let e=t=="start"?this._onStartFns:this._onDoneFns;e.forEach(i=>i()),e.length=0}},it="!";export{u as a,Q as b,J as c,z as d,Ct as e,X as f,Z as g,tt as h,et as i,T as j,C as k,it as l,A as m,w as n,q as o};
