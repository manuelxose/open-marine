<svg
  [attr.viewBox]="'0 0 ' + size + ' ' + size"
  [attr.width]="size"
  [attr.height]="size"
  class="gb-instrument-svg"
  role="img"
  [attr.aria-label]="'Compass: ' + formattedValue + ' ' + unit"
>
  <!-- CAPA 0: DEFS -->
  <defs>
    <radialGradient [attr.id]="faceGradientId" cx="50%" cy="50%" r="50%">
      <stop offset="0%" stop-color="var(--gb-bg-panel)"></stop>
      <stop offset="100%" stop-color="var(--gb-bg-bezel)"></stop>
    </radialGradient>

    <linearGradient [attr.id]="needleGradientId" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="var(--gb-needle-primary)"></stop>
      <stop offset="100%" stop-color="color-mix(in srgb, var(--gb-needle-primary) 70%, var(--gb-bg-canvas))"></stop>
    </linearGradient>

    <filter [attr.id]="neonGlowId" x="-20%" y="-20%" width="140%" height="140%">
      <feGaussianBlur stdDeviation="2" result="blur"></feGaussianBlur>
      <feComposite in="SourceGraphic" in2="blur" operator="over"></feComposite>
    </filter>

    <clipPath [attr.id]="instrumentClipId">
      <circle [attr.cx]="cx" [attr.cy]="cy" [attr.r]="faceRadius"></circle>
    </clipPath>
  </defs>

  <!-- CAPA 1: FONDO -->
  <circle [attr.cx]="cx" [attr.cy]="cy" [attr.r]="outerRadius" fill="var(--gb-bg-bezel)" class="gb-bezel"></circle>

  <circle
    [attr.cx]="cx"
    [attr.cy]="cy"
    [attr.r]="faceRadius"
    [attr.fill]="'url(#' + faceGradientId + ')'"
    stroke="var(--gb-border-panel)"
    stroke-width="1"
    class="gb-face"
  ></circle>

  <!-- CAPA 2: TICKS -->
  <g class="gb-ticks-group">
    <line
      *ngFor="let tick of majorTicks; trackBy: trackByIndex"
      [attr.x1]="tick.x1"
      [attr.y1]="tick.y1"
      [attr.x2]="tick.x2"
      [attr.y2]="tick.y2"
      stroke="var(--gb-tick-major)"
      stroke-width="1.5"
      stroke-linecap="round"
    ></line>

    <line
      *ngFor="let tick of minorTicks; trackBy: trackByIndex"
      [attr.x1]="tick.x1"
      [attr.y1]="tick.y1"
      [attr.x2]="tick.x2"
      [attr.y2]="tick.y2"
      stroke="var(--gb-tick-minor)"
      stroke-width="0.75"
    ></line>
  </g>

  <!-- CAPA 3: CARDINALES -->
  <g class="gb-cardinals-group">
    <text [attr.x]="cx" [attr.y]="cardinalOffset" class="gb-svg-cardinal gb-cardinal-n">N</text>
    <text [attr.x]="cx" [attr.y]="size - cardinalOffset" class="gb-svg-cardinal">S</text>
    <text [attr.x]="size - cardinalOffset" [attr.y]="cy + 1" class="gb-svg-cardinal">E</text>
    <text [attr.x]="cardinalOffset" [attr.y]="cy + 1" class="gb-svg-cardinal">W</text>

    <text
      *ngFor="let label of degreeLabels; trackBy: trackByIndex"
      [attr.x]="label.x"
      [attr.y]="label.y"
      class="gb-svg-degree-label"
      [attr.transform]="label.rotate"
    >
      {{ label.value }}
    </text>
  </g>

  <!-- CAPA 4: DISPLAY DIGITAL -->
  <g
    class="gb-display-group gb-value-updating"
    [class.gb-value-updating--stale]="isStale"
    [gbDataQuality]="timestamp"
    [attr.transform]="'translate(' + cx + ',' + cy + ')'"
  >
    <rect x="-32" y="-22" width="64" height="44" rx="4" fill="color-mix(in srgb, var(--gb-bg-canvas) 70%, transparent)"></rect>

    <text x="0" y="-4" class="gb-svg-value gb-display-value--lg" [attr.font-size]="displayFontSize">
      {{ formattedValue }}
    </text>

    <text x="0" y="14" class="gb-svg-unit" font-size="9">{{ unit }}</text>
  </g>

  <!-- CAPA 5: AGUJA -->
  <g
    class="gb-needle-wrapper"
    [class.gb-needle-wrapper--stale]="isStale"
    [attr.transform]="needleTransform"
    [attr.filter]="needleFilter"
  >
    <polygon [attr.points]="needlePoints" [attr.fill]="'url(#' + needleGradientId + ')'" class="gb-needle-shape"></polygon>
    <polygon [attr.points]="needleCounterweightPoints" fill="var(--gb-bg-bezel)" opacity="0.8"></polygon>
  </g>

  <!-- CAPA 6: PIN CENTRAL -->
  <circle
    [attr.cx]="cx"
    [attr.cy]="cy"
    r="5"
    fill="var(--gb-needle-pin)"
    stroke="var(--gb-needle-pin-border)"
    stroke-width="1.5"
    class="gb-center-pin"
  ></circle>

  <!-- CAPA 7: GLASS OVERLAY -->
  <ellipse
    [attr.cx]="cx"
    [attr.cy]="cy * 0.6"
    [attr.rx]="faceRadius * 0.7"
    [attr.ry]="faceRadius * 0.35"
    fill="var(--gb-text-value)"
    opacity="0.04"
    class="gb-glass-overlay"
  ></ellipse>
</svg>
