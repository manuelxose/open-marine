<ng-container *ngIf="{ compact: isCompact$ | async, layout: layout$ | async } as view">
  <div class="dashboard">
    <div class="dashboard-header">
      <h1>Dashboard</h1>
      <div class="dashboard-actions">
        <button
          class="density-toggle"
          type="button"
          (click)="toggleDensity()"
          [title]="view.compact ? 'Switch to Comfortable' : 'Switch to Compact'"
          [attr.aria-label]="view.compact ? 'Switch to Comfortable' : 'Switch to Compact'"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
               fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7" *ngIf="!view.compact"></rect>
            <rect x="14" y="3" width="7" height="7" *ngIf="!view.compact"></rect>
            <rect x="3" y="14" width="7" height="7" *ngIf="!view.compact"></rect>
            <rect x="14" y="14" width="7" height="7" *ngIf="!view.compact"></rect>
            <rect x="3" y="3" width="4" height="4" *ngIf="view.compact"></rect>
            <rect x="10" y="3" width="4" height="4" *ngIf="view.compact"></rect>
            <rect x="17" y="3" width="4" height="4" *ngIf="view.compact"></rect>
            <rect x="3" y="10" width="4" height="4" *ngIf="view.compact"></rect>
            <rect x="10" y="10" width="4" height="4" *ngIf="view.compact"></rect>
            <rect x="17" y="10" width="4" height="4" *ngIf="view.compact"></rect>
            <rect x="3" y="17" width="4" height="4" *ngIf="view.compact"></rect>
            <rect x="10" y="17" width="4" height="4" *ngIf="view.compact"></rect>
            <rect x="17" y="17" width="4" height="4" *ngIf="view.compact"></rect>
          </svg>
        </button>
      </div>
    </div>

    <ng-container *ngIf="criticalVm$ | async as criticalVm">
      <app-dashboard-critical-strip class="critical-strip" [vm]="criticalVm"></app-dashboard-critical-strip>
    </ng-container>

    <ng-container *ngIf="errorMessage$ | async as errorMessage">
      <div class="error-banner" *ngIf="errorMessage">
        <span>{{ errorMessage }}</span>
        <button type="button" class="error-dismiss" (click)="dismissError()">Dismiss</button>
      </div>
    </ng-container>

    <ng-container *ngIf="statusVm$ | async as statusVm">
      <div
        class="status-banner"
        *ngIf="statusVm.isVisible"
        [class.status-ok]="statusVm.tone === 'ok'"
        [class.status-warn]="statusVm.tone === 'warn'"
        [class.status-alert]="statusVm.tone === 'alert'"
        [class.status-neutral]="statusVm.tone === 'neutral'"
      >
        <span class="status-dot"></span>
        <div class="status-text">
          <span class="status-label">{{ statusVm.label }}</span>
          <span class="status-detail">{{ statusVm.detail }}</span>
        </div>
      </div>
    </ng-container>

    <div class="panel-grid" *ngIf="view.layout?.widgets as widgets">
      <ng-container *ngIf="isVisible(widgets, 'navigation-card')">
        <ng-container *ngIf="navigationVm$ | async as navigationVm">
          <app-dashboard-navigation-panel class="panel navigation" [vm]="navigationVm"></app-dashboard-navigation-panel>
        </ng-container>
      </ng-container>

      <ng-container *ngIf="isVisible(widgets, 'wind-card')">
        <ng-container *ngIf="windVm$ | async as windVm">
          <app-dashboard-wind-panel class="panel wind" [vm]="windVm"></app-dashboard-wind-panel>
        </ng-container>
      </ng-container>

      <ng-container *ngIf="isVisible(widgets, 'depth-card')">
        <ng-container *ngIf="depthVm$ | async as depthVm">
          <app-dashboard-depth-panel class="panel depth" [vm]="depthVm"></app-dashboard-depth-panel>
        </ng-container>
      </ng-container>

      <ng-container *ngIf="isVisible(widgets, 'power-card')">
        <ng-container *ngIf="powerVm$ | async as powerVm">
          <app-dashboard-power-panel class="panel power" [vm]="powerVm"></app-dashboard-power-panel>
        </ng-container>
      </ng-container>

      <ng-container *ngIf="isVisible(widgets, 'system-card')">
        <ng-container *ngIf="systemVm$ | async as systemVm">
          <app-dashboard-system-panel class="panel system" [vm]="systemVm"></app-dashboard-system-panel>
        </ng-container>
      </ng-container>
    </div>
  </div>
</ng-container>
