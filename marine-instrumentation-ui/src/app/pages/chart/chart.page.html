<div class="chart-page">
  <div #mapContainer id="map" class="map-container"></div>

  <ng-container *ngIf="viewModel$ | async as vm">
    <app-chart-hud
      class="chart-hud"
      [fixState]="vm.fixState"
      [metrics]="vm.hudMetrics"
    ></app-chart-hud>

    <div
      class="gps-badge"
      [class.fix]="vm.fixState === 'fix'"
      [class.stale]="vm.fixState === 'stale'"
      [class.no-fix]="vm.fixState === 'no-fix'"
    >
      <div class="badge-title">GPS</div>
      <div class="badge-status">
        {{ vm.fixState === 'fix' ? 'FIX' : vm.fixState === 'stale' ? 'STALE' : 'NO FIX' }}
      </div>
      <div class="badge-coords" *ngIf="vm.hasFix">
        {{ formatLat(vm.currentLat) }} {{ formatLon(vm.currentLon) }}
      </div>
      <div class="badge-age" *ngIf="vm.hasFix">
        {{ (vm.positionAgeSeconds ?? 0) | number: '1.0-0' }}s
      </div>
    </div>

    <div
      class="waypoint-menu"
      *ngIf="pendingWaypoint() as pending"
      [style.left.px]="pending.x"
      [style.top.px]="pending.y"
    >
      <div class="waypoint-title">Waypoint</div>
      <button class="waypoint-action" (click)="addWaypoint(pending)">Add Waypoint</button>
      <button class="waypoint-action secondary" (click)="closeWaypointMenu()">Cancel</button>
    </div>

    <div class="map-controls">
      <div class="toggle-panel">
        <button class="toggle" [class.active]="autoCenter()" (click)="toggleAutoCenter()">
          <span class="toggle-label">Auto-center</span>
          <span class="toggle-state">{{ autoCenter() ? 'ON' : 'OFF' }}</span>
        </button>
        <button class="toggle" [class.active]="showTrack()" (click)="toggleTrack()">
          <span class="toggle-label">Track</span>
          <span class="toggle-state">{{ showTrack() ? 'ON' : 'OFF' }}</span>
        </button>
        <button
          class="toggle"
          [class.active]="showHeadingVector()"
          (click)="toggleHeadingVector()"
        >
          <span class="toggle-label">Heading</span>
          <span class="toggle-state">{{ showHeadingVector() ? 'ON' : 'OFF' }}</span>
        </button>
      </div>

      <button class="center-btn" (click)="centerOnVessel()" [disabled]="!vm.hasFix">
        Center on Boat
      </button>

      <div class="waypoint-panel">
        <div class="panel-title">Waypoints</div>
        <div class="waypoint-list" *ngIf="vm.waypoints.length > 0; else emptyWaypoints">
          <button
            class="waypoint-item"
            *ngFor="let waypoint of vm.waypoints"
            [class.active]="vm.activeWaypointId === waypoint.id"
            (click)="selectWaypoint(waypoint.id)"
          >
            <span class="waypoint-name">{{ waypoint.name }}</span>
            <span class="waypoint-meta">
              {{ formatLat(waypoint.lat) }} {{ formatLon(waypoint.lon) }}
            </span>
          </button>
        </div>
        <ng-template #emptyWaypoints>
          <div class="waypoint-empty">No waypoints</div>
        </ng-template>
        <button
          class="waypoint-clear"
          *ngIf="vm.activeWaypointId"
          (click)="clearActiveWaypoint()"
        >
          Clear Active
        </button>
      </div>
    </div>
  </ng-container>
</div>
