name: OMI CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:

  contract:
    name: Contract — Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: marine-data-contract
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: marine-data-contract/package-lock.json
      - run: npm ci
      - run: npm run build
      - run: npm run test:run

  simulator:
    name: Simulator — Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: marine-data-simulator
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: marine-data-simulator/package-lock.json
      - run: npm ci
      - run: npm run build

  gateway:
    name: Gateway — Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: marine-sensor-gateway
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: marine-sensor-gateway/package-lock.json
      - run: npm ci
      - run: npm run build

  ui-lint:
    name: UI — Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: marine-instrumentation-ui
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: marine-instrumentation-ui/package-lock.json
      - run: npm ci
      - run: npm run lint

  ui-test:
    name: UI — Unit Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: marine-instrumentation-ui
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: marine-instrumentation-ui/package-lock.json
      - run: npm ci
      - run: npm test -- --coverage --run

  ui-build:
    name: UI — Production Build
    needs: [contract, ui-lint, ui-test]
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: marine-instrumentation-ui
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: marine-instrumentation-ui/package-lock.json
      - run: npm ci
      - run: npm run build
      - name: Analyze bundle size
        run: |
          echo "=== Bundle Analysis ==="
          ls -lh dist/*/browser/*.js 2>/dev/null | awk '{print $5, $9}' | sort -h || echo "No JS bundles found"
          echo ""
          echo "=== Total Size ==="
          du -sh dist/ 2>/dev/null || echo "No dist folder"
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: omi-dist
          path: marine-instrumentation-ui/dist/
          retention-days: 7
